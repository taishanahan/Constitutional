//>>built
define("esri/dijit/analysis/mixins/browselayers/BrowseLayerMixin","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/query ../../../../kernel ../../../../request ../../../../lang ../../../../layers/CSVLayer ../../../../arcgis/Portal ../../../../SpatialReference ../../ProjectExtent dojo/Deferred ../../ItemTypes ../../utils ./configs/AGOLBrowseItem ./configs/EnterpriseBrowseItem dojo/i18n!../../nls/BrowseLayerMixin".split(" "),function(t,n,z,R,v,A,q,w,E,B,F,G,u,f,C,H,I,J){t=t([],{tableSupportedTools:"JoinFeatures SummarizeAttributes ExtractData GeocodeLocationsfromTable CopyToDataStore AppendData CalculateField MergeLayers DescribeDataset DetectIncidents".split(" "),
allowedItemTypes:[],defaultItemTypes:[f.MS,f.FS],availableItemTypeFilters:["layers","featureLayers"],_createBrowseItems:function(a,b,c){a=a||{};var h=a.browseValue||{};b=b||{};var g=this.defaultItemTypes.concat(this.get("allowedItemTypes"));if(this.useArcGISComponents)this.setUpItemBrowser(a,b,c).then(function(){this.map&&this._chopExtentAtDateLine(this.map.extent).then(this._projectExtentAndDispatch.bind(this))}.bind(this));else{var l=[];g.forEach(function(k){l.push('type:"'+k+'"')});"browse"===
h?(c=this._browsedlg.browseItems.get("query"),c.custom=this._queryTagsForLivingAtlasBrowseItems(b),this._browsedlg.browseItems.set("extent",this.get("map").extent),this._browsedlg.browseItems.set("query",c),this._browsedlg.show()):(this.showGeoAnalyticsParams&&l.push('type:"'+f.BIGDATA+'"'),c=this._browseLyrsdlg.browseItems.get("query"),c.types=l,this._browseLyrsdlg.browseItems.set("query",c),b.geometryTypes?(this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!0,0<b.geometryTypes.length&&(this._browseLyrsdlg.browseItems.plugIn.geometryTypes=
b.geometryTypes)):this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,b.layerTypes?(this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0,0<b.layerTypes.length&&(this._browseLyrsdlg.browseItems.plugIn.layerTypes=b.layerTypes)):this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!1,b.customCheck?(this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=b.customCheck.customCheckHandler,this._browseLyrsdlg.browseItems.plugIn.customCheckFailureMessage=b.customCheck.customCheckFailureMessage):
this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=void 0,this._browseLyrsdlg.show())}},setUpItemBrowser:function(a,b,c){var h=new u;window.require(["arcgis-components/wrappers/ItemBrowser","esri/arcgis/Portal"],function(g,l){if(!this.ib){var k=document.createElement("div");!a.isDialog&&document.body.appendChild(k);var m=new l.Portal(this.portalSelf&&this.portalSelf.urlKey&&this.portalSelf.customBaseUrl?location.protocol+"//"+this.portalSelf.urlKey+"."+this.portalSelf.customBaseUrl+"/sharing/rest":
(this.portalSelf&&this.portalSelf.portalHostname?location.protocol+"//"+this.portalSelf.portalHostname:this.portalUrl)+"/sharing/rest");"ArcGISEnterpriseOnKubernetes"===(this.portalSelf||{}).portalDeploymentType&&(a.disableBoundary=!0,a.disableLAAL=!0);var p=this.defaultItemTypes.concat(this.get("allowedItemTypes")),K=function(){this._closeFullScreenBrowser();a.isDialog&&this._closeDialog();this._resetSelectBox(c);!a.isDialog&&this._removeDOMfromBody(k)},L=function(d){this._closeFullScreenBrowser();
a.isDialog&&this._closeDialog();d[0]&&d[0].type===f.RFT?this.onSelectRFTTool.bind(this)(d[0],m):d[0]&&d[0].type===f.DLPK?this.onSelectDLPKTool.bind(this)(d[0],m):this.onBrowseItemSelect.bind(this)(d[0],m,c);!a.isDialog&&this._removeDOMfromBody(k)},M=function(d){this._closeFullScreenBrowser();a.isDialog&&this._closeDialog();this.onSelectGPTool.bind(this)(d);!a.isDialog&&this._removeDOMfromBody(k)},N=function(d){this._closeFullScreenBrowser();a.isDialog&&this._closeDialog();this.onEditRFTTool.bind(this)(d,
m);!a.isDialog&&this._removeDOMfromBody(k)},O=function(d){this._closeFullScreenBrowser();a.isDialog&&this._closeDialog();this.onBrowseItemSelect.bind(this)(d,m,c);!a.isDialog&&this._removeDOMfromBody(k)},P=function(d){a.isDialog&&this._closeDialog();d&&d.type===f.RFT?this.onEditRFTTool.bind(this)(d,m):this.onBrowseItemSelect.bind(this)(d,m,c,!0);!a.isDialog&&this._removeDOMfromBody(k)};-1<this.tableSupportedTools.indexOf(this.helpFileName)&&(p=p.concat([this.showGeoAnalyticsParams?f.TABLE:f.BTABLE]));
m.signIn().then(function(){this._fetchGroupForRFT(m).then(function(d){-1<p.indexOf(f.IS)?this.availableItemTypeFilters=["layers","featureLayers","mapImageLayers","imageryLayers"]:-1===p.indexOf(f.GPSERVICE)&&-1===p.indexOf(f.RFT)&&-1===p.indexOf(f.FILE)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["layers","featureLayers"]));-1<this.tableSupportedTools.indexOf(this.helpFileName)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["tables"]));d={allowedItemTypes:this.showGeoAnalyticsParams?
[f.BIGDATA].concat(p):p,availableItemTypeFilters:this.showGeoAnalyticsParams?this.availableItemTypeFilters.concat(["bigDataFileShares"]):this.availableItemTypeFilters,customQueryTags:b,addQueryParameters:a.addQueryParameters,portal:m,isPortal:this.isSingleTenant,onSelectSubLayer:O.bind(this),onActionSubLayer:P.bind(this),onSelectGPTool:M.bind(this),onEditRFT:N.bind(this),rftGroupId:d,disableLAAL:a.disableLAAL,disableBoundary:a.disableBoundary,title:a.title,disabledSubResources:this._getDisableResources(a.disabledSubResources),
showRFTSystemSection:null!=a.showRFTSystemSection?a.showRFTSystemSection:"raster"===a.analysisMode?!0:!1,showRFTEditCustomAction:null!=a.showRFTEditCustomAction?a.showRFTEditCustomAction:!0,enableMapAreaFilter:null!=a.enableMapAreaFilter?a.enableMapAreaFilter:!0};var r=n.mixin(g.initialState.settings.config,this.isSingleTenant?I.getConfig(d):H.getConfig(d)),x=n.mixin(g.initialState.parameters,{section:"myContent",filter:n.mixin(g.initialState.parameters.filter,{searchMapArea:!1})});-1<d.allowedItemTypes.indexOf(f.RFT)&&
!this.isSingleTenant&&(r.addQueryParameters=function(e){return"all"===e.parameters.section?"-owner: (esri_*)":""});if(-1<d.allowedItemTypes.indexOf(f.RFT)&&d.showRFTSystemSection){var Q=this.isSingleTenant;x.section="System";x.sort={field:"title",order:"asc"};r.enableMapAreaFilter=!1;r.addQueryParameters=function(e){var y;return!Q&&e.parameters&&"all"===e.parameters.section?"-owner: (esri_*)":e.parameters&&e.parameters.searchString&&e.parameters.searchString.current&&"System"===e.parameters.section?
(e=e.parameters.searchString.current,-1===e.indexOf(":")&&(y="tags: ("+e+")"),y?y:""):""};var D;z.some(r.customSections,function(e){if("System"===e.name)return D=e.baseQuery,!0});require(["arcgis-raster-function-editor/RFxRegistry"],function(e){e.initialize({sysRFxBaseQuery:D,asRFxEditorBuddy:!1,isMultiTenant:!1===this.isSingleTenant});e=e.createRequestProxy(q);this._originalRequestModule=q;q=e}.bind(this))}this.ib=new g.ItemBrowserWrapper(k,{apiVersion:3,portal:m,request:q,initialState:n.mixin(g.initialState,
{settings:n.mixin(g.initialState.settings,{config:n.mixin(r,{onBack:K.bind(this),onSelect:L.bind(this)})}),ui:n.mixin(g.initialState.ui,{expanded:n.mixin(g.initialState.ui.expanded,{filters:!0})})}),parameters:x});a.isDialog&&this._createDialog(k,m);h.resolve()}.bind(this))}.bind(this))}}.bind(this));return h},_queryTagsForLivingAtlasBrowseItems:function(a){if((a=a&&a.tags)&&0!==a.length){if(1===a.length)return['tags:"'+a[0]+'"'];v=[];a.forEach(function(b){v.push('tags:"'+b+'"')});return v}},onBrowseItemSelect:function(a,
b,c,h){b=this._getPortalItem(a,b);var g={selection:b,dialog:this._browseLyrsdlg||this._browsedlg};!a.url||C.isHostedService(a.url)||this.isSingleTenant||b.selectedLayer instanceof E?this._handleBrowseItemsSelect(g,h):this._getProxyServiceInfo(a).then(function(){w.isDefined(a.analysisProxyCheck)&&"failure"===a.analysisProxyCheck?this._resetSelectBox(c):this._handleBrowseItemsSelect(g,h)}.bind(this),function(){this._resetSelectBox(c)}.bind(this))},onSelectGPTool:function(a){a.resource.url=a.url;this._handleSelectGpTool(a.resource)},
onSelectRFTTool:function(a,b){this._handleSelectRFTTool(this._getPortalItem(a,b))},onSelectDLPKTool:function(a,b){this._handleSelectDLPKTool(this._getPortalItem(a,b))},onEditRFTTool:function(a,b){this._handleEditRFTTool(this._getPortalItem(a,b))},_getPortalItem:function(a,b){a.resource&&a.item?(b=new B.PortalItem(n.mixin(a.item,{portal:b})),b.selectedLayer=a.resource,b.selectedLayer.url=a.url):(b=new B.PortalItem(n.mixin(a,{portal:b})),a.type&&-1<[f.CSV,f.XLS].indexOf(a.type)&&(b.selectedLayer=b));
return b},_createDialog:function(a,b){window.require(["dijit/Dialog","esri/dijit/analysis/mixins/browselayers/configs/Common"],function(c,h){this.itemBrowserDialog||(this.itemBrowserDialog=new c({style:"width: 900px; height:900px; overflow: auto",id:"itemBrowserDialog",closable:!1,title:J.customAnalysisLayerTitle}));this.itemBrowserDialog.set("content",a);this.itemBrowserDialog.show()}.bind(this))},_closeDialog:function(){this.itemBrowserDialog.hide();this.itemBrowserDialog.destroy();delete this.itemBrowserDialog;
delete this.ib},_closeFullScreenBrowser:function(){this._originalRequestModule&&(q=this._originalRequestModule);this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"})},_setAllowedItemTypesAttr:function(a){this.allowedItemTypes=a},_setAvailableItemTypeFiltersAttr:function(a){this.availableItemTypeFilters=a},_getDisableResources:function(a){var b={};a&&a.length&&a.forEach(function(c){c&&c.url&&(b[c.url]=!0)},this);return b},_projectExtentAndDispatch:function(a){this.sr||(this.sr=new F(4326));G(a,this.sr,
function(b){this._dispatchExtentToItemBrowser(b[0])}.bind(this),function(b){}.bind(this))},_chopExtentAtDateLine:function(a){var b=new u;window.esri.geometry.normalizeCentralMeridian([a],null,function(c){if(c[0].rings){var h=(new window.esri.geometry.Polygon(a.spatialReference)).addRing(c[0].rings[0]).getExtent();c=(new window.esri.geometry.Polygon(a.spatialReference)).addRing(c[0].rings[1]).getExtent();b.resolve(h.getWidth()>c.getWidth()?h:c)}else b.resolve(c[0])},function(c){b.reject(c)});return b},
_dispatchExtentToItemBrowser:function(a){window.require(["arcgis-components/wrappers/ItemBrowser"],function(b){this.ib.dispatch(b.updateExtent({minx:a.xmin,miny:a.ymin,maxx:a.xmax,maxy:a.ymax}))}.bind(this))},_fetchGroupForRFT:function(a){var b=new u;-1===this.allowedItemTypes.indexOf(f.RFT)&&b.resolve();this._systemRFTsGroup&&b.resolve(this._systemRFTsGroup);C.fetchGroupForRFT(a).then(function(c){this._systemRFTsGroup=c;b.resolve(c)}.bind(this));return b},_removeDOMfromBody:function(a){setTimeout(function(){document.body.removeChild(a)},
300);delete this.ib},_resetSelectBox:function(a){a&&a.reset()},_getProxyServiceInfo:function(a){var b=new u,c;w.isDefined(a)&&w.isDefined(a.url)||b.reject({error:"mapLayer is not defined"});var h=a.url+(-1<a.url.indexOf("?")?"\x26":"?")+"f\x3djson";var g=A.id.findCredential(a.url);var l=a.url;this.proxyCheckedServers||(this.proxyCheckedServers=[]);z.some(this.proxyCheckedServers,function(k){c=l.substring(0,l.indexOf("/",9));if(k.server===c)return a.analysisProxyCheck=k.check,!0},this)?b.resolve({}):
(g&&g.token&&(h+="\x26token\x3d"+g.token),b=q({url:h,content:null},{useProxy:!0}),b.then(function(){a.analysisProxyCheck="success";this.proxyCheckedServers.push({server:l.substring(0,l.indexOf("/",9)),check:"success"})}.bind(this),function(){a.analysisProxyCheck="failure";this.proxyCheckedServers.push({server:l.substring(0,l.indexOf("/",9)),check:"failure"})}.bind(this)));return b.promise}});n.setObject("dijit.analysis.mixins.browselayers.BrowseLayerMixin",t,A);return t});