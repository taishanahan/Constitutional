//>>built
require({cache:{"url:esri/dijit/templates/CalculateField.html":'\x3cdiv class\x3d"${_css.base}"\x3e\r\n  \x3cdiv class\x3d"esriFloatLeading esriCalcHelp" data-dojo-attach-point\x3d"_helpNode"\x3e\r\n    \x3ca href\x3d"#" data-dojo-attach-point\x3d"_helpurlNode" target\x3d\'_help\' class\x3d""\x3e${i18n.learnMore}\x3c/a\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv data-dojo-type\x3d"dijit/layout/ContentPane" data-dojo-attach-point\x3d"_headerPane" style\x3d"width:99%;margin-top:0.5em; margin-bottom: 0.5em;"\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"_header" class\x3d"${_css.titleLabel}"\x3e\r\n       \x3cdiv class\x3d"esriAlignLeading"\x3e${i18n.expBuilderTitle}\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${_css.titleDividerLine}"\x3e\x3c/div\x3e\r\n  \x3c/div\x3e  \r\n  \x3cdiv data-dojo-type\x3d"dijit/form/Form" data-dojo-attach-point\x3d"_expressionForm" style\x3d"height:100%;width:99%;"\x3e\r\n    \x3cdiv class\x3d"esriFloatLeading" data-dojo-attach-point\x3d"_selCalcFieldDiv" style\x3d"width:100%;padding-bottom:0.5em;"\x3e\r\n      \x3cdiv\x3e\x3clabel class\x3d"esriLeadingMargin1"\x3e${i18n.selectCalField}\x3c/label\x3e\x3c/div\x3e\r\n      \x3cselect class\x3d"esriLeadingMargin1 ${_css.selectField}" data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-point\x3d"_selCalcField"\x3e\x3c/select\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"width:100%;padding-bottom:0.5em;" class\x3d"esriFloatLeading"\x3e\r\n      \x3clabel class\x3d"esriLeadingMargin1" data-dojo-attach-point\x3d"_calcFieldLabel"\x3e\x3c/label\x3e\r\n    \x3c/div\x3e\r\n    \x3cinput class\x3d"esriFloatLeading esriLeadingMargin1 ${_css.expressionBox}" dir\x3d"ltr" data-dojo-type\x3d"dijit/form/SimpleTextarea" data-dojo-attach-point\x3d"_exprBox" data-dojo-props\x3d"rows:${expressionBoxRows} ,cols:${expressionBoxCols},required:true,intermediateChanges:true"\x3e\x3c/input\x3e\r\n    \x3cdiv class\x3d"esriFloatLeading ${_css.actionBtnContainer}"\x3e\r\n      \x3cdiv class\x3d"esriFloatLeading esriLeadingMargin1" style\x3d"width:70%;padding-bottom:0.5em;" dir\x3d"ltr" data-dojo-attach-point\x3d"_operatorCtr"\x3e\x3c/div\x3e\r\n      \x3cdiv data-dojo-type\x3d"dijit/form/Button" class\x3d"${_css.actionButton} esriFloatTrailing esriTrailingMargin1" data-dojo-props\x3d"label:\'${i18n.remove}\',iconClass:\'${_css.clearIcon}\',showLabel: false, disabled:true" data-dojo-attach-event\x3d"onClick:_handleRemoveBtnClick" data-dojo-attach-point\x3d"_removeBtn"\x3e\x3c/div\x3e\r\n      \x3cdiv data-dojo-type\x3d"dijit/form/Button" class\x3d"${_css.actionButton} esriFloatTrailing esriTrailingMargin1" data-dojo-props\x3d"label:\'${i18n.validate}\',iconClass:\'${_css.validateIcon}\',showLabel: false, disabled:true" data-dojo-attach-event\x3d"onClick:_handleValidationBtnClick" data-dojo-attach-point\x3d"_validateBtn"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${_css.fieldFunctionContainer}"\x3e\r\n      \x3cdiv class\x3d"esriFloatLeading ${_css.fieldContainer}"\x3e\r\n        \x3cdiv class\x3d"${_css.fieldLabelDiv}"\x3e\x3clabel class\x3d"esriLeadingMargin1 ${_css.titleLabel}"\x3e${i18n.fields}\x3c/label\x3e\x3c/div\x3e\r\n        \x3cdiv class\x3d"${_css.fieldTypeContainer}"\x3e\r\n          \x3clabel class\x3d"esriLeadingMargin1 esriSelectLabel"\x3e\r\n            \x3cinput type\x3d"radio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-attach-point\x3d"_strRadioBtn" data-dojo-props\x3d"\'class\':\'esriSelectLabel\'" name\x3d"functionType" value\x3d"StrType"/\x3e\r\n            ${i18n.stringLabel}\r\n          \x3c/label\x3e\r\n          \x3clabel class\x3d"esriLeadingMargin1 esriSelectLabel"\x3e\r\n            \x3cinput type\x3d"radio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-attach-point\x3d"_numRadioBtn" data-dojo-props\x3d"\'class\':\'esriSelectLabel\'" name\x3d"functionType" value\x3d"NumType"/\x3e \r\n            ${i18n.numeric}\r\n          \x3c/label\x3e\r\n          \x3clabel class\x3d"esriLeadingMargin1 esriSelectLabel"\x3e\r\n            \x3cinput type\x3d"radio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-attach-point\x3d"_dateRadioBtn"  data-dojo-props\x3d"\'class\':\'esriSelectLabel\'" name\x3d"functionType" value\x3d"DateType"/\x3e\r\n            ${i18n.dateLabel}\r\n          \x3c/label\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"esriLeadingMargin1 ${_css.fieldListContainer}" dir\x3d"ltr" data-dojo-attach-point\x3d"_attributeListCtr"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"esriFloatTrailing ${_css.functionContainer}"\x3e\r\n        \x3cdiv class\x3d"${_css.functionLabelDiv}"\x3e\r\n          \x3clabel class\x3d"${_css.titleLabel}"\x3e${i18n.functions}\x3c/label\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"_helpersListCtr" dir\x3d"ltr" class\x3d"${_css.functionListContainer}"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriLeadingMargin05 ${_css.formWarning} esriRoundedBox" data-dojo-attach-point\x3d"_errorMessagePane" style\x3d"clear:both;display:none;"\x3e\r\n      \x3ca href\x3d"#" title\x3d"${i18n.close}" class\x3d"esriFloatTrailing esri-icon-close" title\x3d\'${i18n.close}\' data-dojo-attach-event\x3d"onclick:_handleCloseMsg"\x3e\r\n      \x3c/a\x3e\r\n      \x3cspan data-dojo-attach-point\x3d"_bodyNode" style\x3d"width:100%;height:100%;"\x3e\x3c/span\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${_css.actionDividerLine}"\x3e\x3c/div\x3e\r\n    \x3cdiv  class\x3d"esriFloatTrailing esriTrailingMargin2 esriCalcFieldActionCtr" data-dojo-attach-point\x3d"_buttonCtr"\x3e\r\n      \x3cdiv data-dojo-type\x3d"dijit/form/Button"  class\x3d"${_css.addButton}" data-dojo-attach-point\x3d"_addBtn" data-dojo-attach-event\x3d"onClick:_handleAddButtonClick"\x3e\r\n        ${calculateLabel}\r\n      \x3c/div\x3e\r\n       \x3cdiv data-dojo-type\x3d"dijit/form/Button" class\x3d"esriLeadingMargin05 ${_css.closeButton}" data-dojo-attach-point\x3d"_closeBtn" data-dojo-attach-event\x3d"onClick:_handleCloseButtonClick"\x3e\r\n        ${i18n.close}\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"_arcadeExpressionEditorDlg"\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"dijitDialogUnderlayWrapper" data-dojo-attach-point\x3d"_underlay" style\x3d"position:absolute;z-index:949;display:none;top:0px;left:0px;width:100%;height:100%;"\x3e\r\n    \x3cdiv class\x3d"dijitDialogUnderlay" tabindex\x3d"-1" style\x3d"width:100%;height:100%"\x3e\x3c/div\x3e\r\n    \x3cdiv class\x3d"${_css.loadingIcon}" style\x3d"height:100%;"\x3e\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e  \r\n'}});
define("esri/dijit/CalculateField","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/kernel dojo/_base/fx dojo/has dojo/json dojo/string dojo/dom-style dojo/dom-attr dojo/dom-construct dojo/query dojo/dom-class dojo/_base/event dojo/Evented dojo/fx/easing dojo/store/Memory dojo/mouse dojo/on dojo/topic dojo/_base/window dojo/Deferred dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/_OnDijitClickMixin dijit/_FocusMixin dijit/registry dijit/form/Button dijit/form/CheckBox dijit/form/Form dijit/form/Select dijit/form/MultiSelect dijit/form/TextBox dijit/form/SimpleTextarea dijit/form/ValidationTextBox dijit/layout/ContentPane dijit/form/ComboBox dijit/Dialog dijit/Tooltip dgrid/OnDemandList dgrid/Selection dgrid/Keyboard dgrid/extensions/DijitRegistry dgrid/util/mouse put-selector/put ../kernel ../lang ../request ./SingleFilter ./ExpressionEditor dojo/i18n!../nls/jsapi dojo/text!./templates/CalculateField.html".split(" "),
function(C,d,h,ba,D,u,E,ca,da,m,l,v,n,ea,w,F,N,G,z,H,I,J,K,O,P,Q,R,S,T,fa,U,ha,ia,ja,ka,la,ma,na,oa,pa,qa,A,V,W,X,Y,x,ra,y,r,B,sa,Z,q,aa){var L=C([V,X,W,Y]),M={base:"esriCalcField",titleLabel:"esriCalcTitleLabel",selectField:"esriCalcSelField",expressionBox:"esriExprBox",actionBtnContainer:"esriActionButtonCtr",validateIcon:"esriCalcFieldValidateIcon",validateDisabledIcon:"esriCalcFieldValidateDisabledIcon",actionButton:"esriActionButton",clearIcon:"esriCalcFieldClearIcon",clearDisabledIcon:"esriCalcFieldClearDisabledIcon",
fieldFunctionContainer:"esriCalcFieldFuncCtr",fieldContainer:"esriCalcFieldCtr",functionContainer:"esriCalcFuncCtr",fieldLabelDiv:"esriFieldsLabelDiv",functionLabelDiv:"esriFunctionLabelDiv",fieldListContainer:"esriCalcFieldsList",functionListContainer:"esriCalcFunctionList",fieldTypeContainer:"esriFieldsSelectionCtr",loadingIcon:"esriLoadingLarge",formWarning:"esriFormWarning",formSuccess:"esriFormSuccess",addButton:"",closeButton:"",actionDividerLine:"esriActionDividerLine",titleDividerLine:"esriTitleDivideLine",
actionCtr:"esriCalcFieldActionCtr"},p=C([P,Q,R,S,T,N],{declaredClass:"esri.dijit.CalculateField",templateString:aa,widgetsInTemplate:!0,showSelectField:!1,showHeader:!0,closeOnAdd:!0,addButtonClass:"",closeButtonClass:"",_showMsgTimerInterval:3E3,showHelp:!1,expressionBoxRows:4,expressionBoxCols:2,baseClass:M.base,constructor:function(a){a.containerNode&&(this.container=a.containerNode);this._css=d.mixin(M,a.css);this.expressionMode=r.isDefined(a.expressionMode)?a.expressionMode:p.MODE_SQL;this.fieldId=
a.fieldId;this.arcadeProfile=a.arcadeProfile;this.arcadeProfileType=a.arcadeProfileType},destroy:function(){this.inherited(arguments)},postMixInProperties:function(){this.inherited(arguments);this.i18n={};d.mixin(this.i18n,q.common);d.mixin(this.i18n,q.calculateFields);this.calculateLabel||(this.calculateLabel=this.i18n.calculate)},postCreate:function(){this.inherited(arguments);if(this.expressionMode===p.MODE_ARCADE)this._loadArcadeUIEvents(),this._buildArcadeEditorUI();else{var a=["ar","he"],b;
for(b=0;b<a.length;b+=1){var c=a[b];u.locale&&-1!==u.locale.indexOf(c)&&(-1!==u.locale.indexOf("-")?-1!==u.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0)}this._buildUI();this._loadEvents();this.onlineHelpMap={};l.set(this._helpNode,"display",this.showHelp?"block":"none");this.helpUrl&&v.set(this._helpurlNode,"href",this.helpUrl);this.validate()}},_loadArcadeUIEvents:function(){d.mixin(this.i18n,q.expressionEditor);this.own(this.watch("layer",d.hitch(this,this._buildArcadeEditorUI)))},
_deleteArcadeEditorUI:function(){this.expressionEditor&&this._destroyArcadeUI()},_buildArcadeEditorUI:function(){this._deleteArcadeEditorUI();var a=this.expressionMode===p.MODE_ARCADE;l.set(this._expressionForm,"display",a?"none":"block");l.set(this._headerPane.domNode,"display",a?"none":"block");l.set(this._arcadeExpressionEditorDlg,"display",a?"block":"none");this.expressionEditorCommitHandler=J.subscribe("expression-commit",d.hitch(this,function(b){this.set("expression",b.expression);this.emit("expression-add",
b);this._close()}));this.expressionEditorCancelHandler=J.subscribe("expression-cancel",d.hitch(this,function(){this._close()}));r.isDefined(this.fieldId)||(this.fieldId="$feature");this.expressionEditor=new Z({arcadeEditor:this.arcadeEditor,map:this.map,mapLayer:{layer:this.layer,popupInfo:this.layer.infoTemplate?this.layer.infoTemplate.toJson():null},layer:this.layer,expression:this.get("expression"),captureTitle:!1,fieldId:this.fieldId,arcadeProfile:this.arcadeProfile,arcadeProfileType:this.arcadeProfileType,
showViewScale:!1},n.create("div",null,this._arcadeExpressionEditorDlg));this.expressionEditor.startup();this.own(this.watch("arcadeProfile",d.hitch(this,function(){this.expressionEditor.set("arcadeProfile",this.get("arcadeProfile"))})))},_destroyArcadeUI:function(){this.expressionEditorCommitHandler&&this.expressionEditorCommitHandler.remove();this.expressionEditorCommitHandler=null;this.expressionEditorCancelHandler&&this.expressionEditorCancelHandler.remove();this.expressionEditorCancelHandler=
null;this.expressionEditor&&this.expressionEditor.destroy();this.expressionEditor=null;this.expression&&(this.expression=null)},_buildUI:function(){var a=[];l.set(this._header,"display",this.showHeader?"block":"none");l.set(this._selCalcFieldDiv,"display",this.showSelectField?"block":"none");if(this.field){var b=h.filter(this.layer.fields,function(c){return c.name===this.field},this);this._calcField=b=b[0];v.set(this._calcFieldLabel,"innerHTML",m.substitute(this.i18n.exprLabel,{fieldName:b?b.name:
this.field}))}if(!this.helperMethods||this.helperMethods&&0===this.helperMethods.length)b=this._labelFormatter.bind(this),b=[{type:"NumType",label:b({functionName:"ABS(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.absFunc,functionParams:[{name:"number",label:this.i18n.commonNumberParamDesc}]}),name:"ABS()"},{type:"NumType",label:b({functionName:"CAST(\x3ci\x3eexpression\x3c/i\x3e AS FLOAT|INT)",functionDesc:this.i18n.castFunc,functionParams:[{name:"expression",label:this.i18n.castParam1Desc},
{name:"FLOAT",label:this.i18n.castParam2Desc},{name:"INT",label:this.i18n.castParam3Desc}]}),name:"CAST()"},{type:"NumType",label:b({functionName:"CEILING(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.ceilingFunc,functionParams:[{name:"number",label:this.i18n.ceilingParamDesc}]}),name:"CEILING()"},{type:"NumType",label:b({functionName:"COS(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.cosFunc,functionParams:[{name:"number",label:this.i18n.trignomParamDesc}]}),name:"COS()"},{type:"NumType",
label:b({functionName:"FLOOR(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.floorFunc,functionParams:[{name:"number",label:this.i18n.floorParamDesc}]}),name:"FLOOR()"},{type:"NumType",label:b({functionName:"LOG(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.logFunc,functionParams:[{name:"number",label:this.i18n.commonNumberParamDesc}]}),name:"LOG()"},{type:"NumType",label:b({functionName:"LOG10(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.log10Func,functionParams:[{name:"number",label:this.i18n.commonNumberParamDesc}]}),
name:"LOG10()"},{type:"NumType",label:b({functionName:"MOD(\x3ci\x3enumber\x3c/i\x3e, \x3ci\x3en\x3c/i\x3e)",functionDesc:this.i18n.modFunc,functionParams:[{name:"number",label:this.i18n.modParam1Desc},{name:"n",label:this.i18n.modParam2Desc}]}),name:"MOD(,)"},{type:"NumType",label:b({functionName:"NULLIF(\x3ci\x3enumber\x3c/i\x3e,\x3ci\x3evalue\x3c/i\x3e)",functionDesc:this.i18n.nullifFunc,functionParams:[{name:"number",label:this.i18n.commonNumberParamDesc},{name:"value",label:this.i18n.commonNumberParamDesc}]}),
name:"NULLIF(,)"},{type:"NumType",label:b({functionName:"POWER(\x3ci\x3enumber\x3c/i\x3e, \x3ci\x3ey\x3c/i\x3e)",functionDesc:this.i18n.powerFunc,functionParams:[{name:"number",label:this.i18n.powerParam1Desc},{name:"y",label:this.i18n.powerParam2Desc}]}),name:"POWER(,)"},{type:"NumType",label:b({functionName:"ROUND(\x3ci\x3enumber\x3c/i\x3e, \x3ci\x3elength\x3c/i\x3e)",functionDesc:this.i18n.roundFunc,functionParams:[{name:"number",label:this.i18n.roundParam1Desc},{name:"length",label:this.i18n.roundParam2Desc}]}),
name:"ROUND(,)"},{type:"NumType",label:b({functionName:"SIN(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.sinFunc,functionParams:[{name:"number",label:this.i18n.trignomParamDesc}]}),name:"SIN()"},{type:"NumType",label:b({functionName:"TAN(\x3ci\x3enumber\x3c/i\x3e)",functionDesc:this.i18n.tanFunc,functionParams:[{name:"number",label:this.i18n.trignomParamDesc}]}),name:"TAN()"},{type:"NumType",label:b({functionName:"TRUNCATE(\x3ci\x3enumber\x3c/i\x3e, \x3ci\x3edecimal_place\x3c/i\x3e)",functionDesc:this.i18n.truncateFunc,
functionParams:[{name:"number",label:this.i18n.truncateParam1Desc},{name:"decimal_place",label:this.i18n.truncateParam2Desc}]}),name:"TRUNCATE(,)"},{type:"StrType",label:b({functionName:"CHAR_LENGTH(\x3ci\x3estring\x3c/i\x3e)",functionDesc:this.i18n.char_lengthFunc,functionParams:[{name:"string",label:this.i18n.char_lengthParamDesc}]}),name:"CHAR_LENGTH()"},{type:"StrType",label:b({functionName:"CONCAT(\x3ci\x3estring1\x3c/i\x3e, \x3ci\x3estring2\x3c/i\x3e)",functionDesc:this.i18n.concatFunc,functionParams:[{name:"string1",
label:this.i18n.concatParam1Desc},{name:"string2",label:this.i18n.concatParam2Desc}]}),name:"CONCAT(,)"},{type:"StrType",label:b({functionName:"POSITION(\x3ci\x3esubstring\x3c/i\x3e, \x3ci\x3estring\x3c/i\x3e)",functionDesc:this.i18n.positionFunc,functionParams:[{name:"substring",label:this.i18n.positionParam1Desc},{name:"string",label:this.i18n.positionParam2Desc}]}),name:"POSITION(,)"},{type:"StrType",label:b({functionName:"LOWER(\x3ci\x3estring\x3c/i\x3e)",functionDesc:this.i18n.lowerFunc,functionParams:[{name:"string",
label:this.i18n.lowerParamDesc}]}),name:"LOWER()"},{type:"StrType",label:b({functionName:"SUBSTRING(\x3ci\x3estring\x3c/i\x3e, \x3ci\x3estart\x3c/i\x3e, \x3ci\x3elength\x3c/i\x3e)",functionDesc:this.i18n.substringFunc,functionParams:[{name:"string",label:this.i18n.substrParam1Desc},{name:"start",label:this.i18n.substrParam2Desc},{name:"length",label:this.i18n.substrParam3Desc}]}),name:"SUBSTRING(,,)"},{type:"StrType",label:b({functionName:"TRIM(BOTH|LEADING|TRAILING \u2018 \u2018 FROM string)",functionDesc:this.i18n.trimFunc,
functionParams:[{name:"BOTH",label:this.i18n.trimBothDesc},{name:"LEADING",label:this.i18n.trimLeadingDesc},{name:"TRAILING",label:this.i18n.trimTrailingDesc},{name:"string",label:this.i18n.trimParamDesc}]}),name:"TRIM()"},{type:"StrType",label:b({functionName:"UPPER(\x3ci\x3estring\x3c/i\x3e)",functionDesc:this.i18n.upperFunc,functionParams:[{name:"string",label:this.i18n.upperParamDesc}]}),name:"UPPER()"},{type:"DateType",label:b({functionName:"CURRENT_DATE()",functionDesc:this.i18n.current_dateFunc}),
name:"CURRENT_DATE()"},{type:"DateType",label:m.substitute(this.i18n.current_timeFunc,{functionName:"CURRENT_TIME()"}),name:"CURRENT_TIME()"},{type:"DateType",label:m.substitute(this.i18n.current_timestampFunc,{functionName:"CURRENT_TIMESTAMP()"}),name:"CURRENT_TIMESTAMP()"},{type:"DateType",label:b({functionName:"EXTRACT(unit FROM date)",functionDesc:this.i18n.extractFunc,functionParams:[{name:"unit",label:this.i18n.extractUnitDesc},{name:"date",label:this.i18n.extractDataDesc}]}),name:"EXTRACT()"}],
h.forEach(b,function(c){c.label="\x3cb\x3e"+c.label.substring(0,c.label.indexOf(":")+1)+"\x3c/b\x3e\x3cbr/\x3e "+c.label.substring(c.label.indexOf(":")+1)},this),this.set("helperMethods",b);(!this.operators||this.operators&&0===this.operators.length)&&this.set("operators","+-/*()".split(""));this._operatorBtns=[];h.forEach(this.operators,function(c){this._operatorBtns.push(new U({value:c,label:c,style:{width:"4em"},onClick:d.hitch(this,this._updateExpression,{value:c,type:"operator"})},n.create("div",
null,this._operatorCtr)))},this);this.layer&&this.layer.fields&&0<this.layer.fields.length&&(a=this._createIds(this.layer.fields),b=h.map(this.layer.fields,function(c){return{label:c.name,value:c.name}}),this._selCalcField.addOption(b),this._selCalcField.set("value",this.field));this.fieldsStore=new z({data:a});this.attributeList=new L({renderRow:d.hitch(this,this._renderAttributesRow),selectionMode:"single",store:this.fieldsStore},this._attributeListCtr);a=this._createIds(this.get("helperMethods"));
this.operatorStore=new z({data:a});this.helpersList=new L({renderRow:d.hitch(this,this._renderOperatorRow),selectionMode:"single",store:this.operatorStore},this._helpersListCtr)},_loadEvents:function(){this.own(this.watch("fields",d.hitch(this,this._handleFieldsChange)),this.watch("field",d.hitch(this,this._handleFieldChange)));this.showSelectField&&this.own(this._selCalcField.on("change",d.hitch(this,this._handleSelcCalFieldChange)));this.own(this._expressionForm.watch("value",d.hitch(this,this._handleHelperTypeChange)),
this._expressionForm.on("focus",d.hitch(this,this._setfocus)),this._exprBox.watch("value",d.hitch(this,this._handleExpChange)),this.attributeList.on("dgrid-select",d.hitch(this,function(a){this._updateExpression({value:a.rows[0].data,type:"field"})})),this.helpersList.on("dgrid-select",d.hitch(this,function(a){this._updateExpression({value:a.rows[0].data,type:"helper"})})),this.attributeList.on(x.enterRow,d.hitch(this,function(a){a=this.attributeList.row(a);var b=a.data.alias||a.data.name;var c="";
c=this._getTypeLabel(a.data.type);this._showTooltip(a.element,"\x3cb\x3e"+b+"\x3c/b\x3e: "+c)})),this.attributeList.on(x.leaveRow,d.hitch(this,function(a){a=this.attributeList.row(a);this._hideTooltip(a.element)})),this.helpersList.on(x.enterRow,d.hitch(this,function(a){a=this.helpersList.row(a);this._showTooltip(a.element,a.data.label)})),this.helpersList.on(x.leaveRow,d.hitch(this,function(a){a=this.helpersList.row(a);this._hideTooltip(a.element)})),this.attributeList.on("dgrid-refresh-complete",
d.hitch(this,this._setfocus)),this.helpersList.on("dgrid-refresh-complete",d.hitch(this,this._setfocus)),this._exprBox.on("blur",d.hitch(this,function(){this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?this._exprBox.set("cursorPosition",[this._exprBox.textbox.selectionStart,this._exprBox.textbox.selectionEnd]):this._exprBox.set("cursorPosition",this._getCursorRange(this._exprBox.textbox))})),this._exprBox.on("focus",d.hitch(this,function(){var a=this._exprBox.get("cursorPosition");
a&&(this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?this._exprBox.textbox.setSelectionRange(a[1],a[1]):this._setCaretPosition(this._exprBox.textbox,a[1],a[1]))})),I(this._calcFieldLabel,H.enter,d.hitch(this,function(a){a="";a=this._getTypeLabel(this._calcField.type);this._showTooltip(this._calcFieldLabel,"\x3cb\x3e"+this._calcField.alias+"\x3c/b\x3e: "+a)})),I(this._calcFieldLabel,H.leave,d.hitch(this,function(a){this._hideTooltip(this._calcFieldLabel)})))},
startup:function(){this.inherited(arguments);this.expressionMode===p.MODE_SQL&&(this.attributeList.startup(),this.helpersList.startup(),this.set("helperType",this.helperType))},reset:function(){y.show(this.domNode);this.expressionMode===p.MODE_SQL?(this._expressionForm.reset(),this._handleCloseMsg(),this.set("helperType",this.helperType)):this._buildArcadeEditorUI()},_close:function(){this.emit("close",{});y.hide(this.domNode);this._deleteArcadeEditorUI()},_createIds:function(a){var b=[];a&&0<a.length&&
(b=h.map(a,function(c,e){return d.mixin(c,{id:e})}));return b},_renderAttributesRow:function(a){var b=n.create("div",{"class":"esriCalExpRowOuter"}),c=n.create("div",{"class":"esriCalcExpLabelRow"},b);n.create("div",{"class":"esriCalcFieldTextTrimWithEllipses",innerHTML:a.name},c);return b},_renderOperatorRow:function(a){var b=n.create("div",{"class":"esriCalExpRowOuter"}),c=n.create("div",{"class":"esriCalcExpLabelRow"},b);n.create("div",{"class":"esriCalcFieldTextTrimWithEllipses",innerHTML:a.name},
c);return b},_handleFieldsChange:function(a,b,c){a=[];this.layer&&this.layer.fields&&0<this.layer.fields.length&&(0<this._selCalcField.getOptions().length&&this._selCalcField.removeOption(this._selCalcField.getOptions()),a=this._createIds(this.layer.fields),b=h.map(this.layer.fields,function(e){return{label:e.name,value:e.name}}),this._selCalcField.addOption(b),this._selCalcField.set("value",this.field));this.fieldsStore=new z({data:a});this.attributeList.set("store",this.fieldsStore)},_handleFieldChange:function(a,
b,c){v.set(this._calcFieldLabel,"innerHTML",m.substitute(this.i18n.exprLabel,{fieldName:c}));this.set("helperType",this.helperType);this._setfocus()},_setHelperTypeAttr:function(a){if(a)this.helperType=a;else if(this.field){var b=h.filter(this.layer.fields,function(c){return c.name===this.field},this);(this._calcField=b=b[0])&&-1!==h.indexOf(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"],b.type)?a="date":b&&"esriFieldTypeString"===b.type?a="string":
b&&-1!==h.indexOf(["esriFieldTypeBigInteger","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],b.type)&&(a="numeric")}else a="string";"string"===a?this._strRadioBtn.set("checked",!0):"numeric"===a?this._numRadioBtn.set("checked",!0):"date"===a&&this._dateRadioBtn.set("checked",!0)},_handleHelperTypeChange:function(a,b,c){this.helpersList.set("query",{type:c.functionType});"DateType"===c.functionType?this.attributeList.set("query",function(e){return-1!==
h.indexOf(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"],e.type)}):"StrType"===c.functionType?this.attributeList.set("query",{type:"esriFieldTypeString"}):"NumType"===c.functionType&&this.attributeList.set("query",function(e){return-1!==h.indexOf(["esriFieldTypeBigInteger","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],e.type)});this.helpersList.refresh();this.attributeList.refresh()},_handleSelcCalFieldChange:function(a){this.set("field",
a)},_handleRemoveBtnClick:function(){this._exprBox.set("value","");this._setfocus()},_handleAddButtonClick:function(a){F.stop(a);var b={f:"json"},c;this._exprBox.get("value")?(this._handleCloseMsg(),b.calcExpression=D.toJson(this.get("expression")),b.sqlFormat="standard",this.layer.supportsASyncCalculate&&(b.async=!0),this.layer.getDefinitionExpression&&this.layer.getDefinitionExpression()?b.where=this.layer.getDefinitionExpression():r.isDefined(this.layer.definitionExpression)&&""!==this.layer.definitionExpression&&
(b.where=this.layer.definitionExpression),y.id.getCredential(this.layer.url+"/calculate").then(d.hitch(this,function(e){b.token=e.token;c=B({url:this.layer.url+"/calculate",content:b},{usePost:!0});this.emit("calculate-start",{calcPromise:c.promise});this._addBtn.set("disabled",!0);this._showLoading();c.then(d.hitch(this,function(g){this._checkStatus(g).then(d.hitch(this,function(f){this._addBtn.set("disabled",!1);this._hideLoading();var k={};d.mixin(k,{calcExpression:D.fromJson(b.calcExpression)[0].sqlExpression,
where:b.where,sqlFormat:b.sqlFormat},f);this.emit("calculate-success",k);this.layer.refresh();w.toggle(this._errorMessagePane,this._css.formSuccess,!0);this._showMessages(m.substitute(this.i18n.successMsg,{count:f.updatedFeatureCount||f.recordCount}),!0);this.closeOnAdd&&this._close()}))}),d.hitch(this,this._handleErrorResponse))}),d.hitch(this,this._handleErrorResponse))):this._addBtn.set("disabled",!0)},_checkStatus:function(a,b,c){var e=a&&a.statusUrl,g=c||new O,f=b||500;c={f:"json"};this.layer.supportsASyncCalculate?
B({url:e,content:c},{usePost:!0}).then(d.hitch(this,function(k){k=k||{status:"completed"};var t=k.status;t&&"completed"===t.toLowerCase()?g.resolve(k):t&&"failed"===t.toLowerCase()||400<k.code||""===t?this._handleErrorResponse(k):(f+=250,setTimeout(d.hitch(this,function(){this._checkStatus(a,f,g)}),b))}),d.hitch(this,function(k){this._handleErrorResponse(k)})):g.resolve(a);return g},_handleErrorResponse:function(a){this._addBtn.set("disabled",!1);this._hideLoading();this.emit("calculate-error",a);
w.toggle(this._errorMessagePane,this._css.formSuccess,!1);this._showMessages(m.substitute(this.i18n.exprFailedMsg,{expr:this._exprBox.get("value")})+"\x3cbr/\x3e"+(a.details||a.description).toString())},_handleCloseButtonClick:function(a){F.stop(a);this._close()},_showTooltip:function(a,b){b=n.create("label",{innerHTML:b,className:"esriSmallFont",dir:"ltr"});this._isRightToLeft?A.show(b.outerHTML,a,["after"],!0):A.show(b.outerHTML,a,["after"])},_hideTooltip:function(a,b){A.hide(a)},_setfocus:function(){this._exprBox.focus()},
_showMessages:function(a,b){v.set(this._bodyNode,"innerHTML",a);E.fadeIn({node:this._errorMessagePane,easing:G.quadIn,onEnd:d.hitch(this,function(){l.set(this._errorMessagePane,{display:""})})}).play();b&&window.setTimeout(d.hitch(this,this._handleCloseMsg),this._showMsgTimerInterval)},_handleCloseMsg:function(a){a&&a.preventDefault();"none"!==l.get(this._errorMessagePane,"display")&&E.fadeOut({node:this._errorMessagePane,easing:G.quadOut,onEnd:d.hitch(this,function(){l.set(this._errorMessagePane,
{display:"none"})})}).play()},validate:function(){var a=!0;this.layer?this.field?this.layer.supportsCalculate?this.layer.userIsAdmin||this.layer.getEditCapabilities().canUpdate||(m.substitute(this.i18n.lyrUpdateCapMsg,{layername:this.layer.name}),a=!1):(m.substitute(this.i18n.lyrSupportCalMsg,{layername:this.layer.name}),a=!1):a=!1:a=!1;this._addBtn.set("disabled",!a);return a},_validateExpObj:function(a){var b=!0;a||(b=!1);b?this._handleCloseMsg():this._showMessages(void 0);return b},_updateExpression:function(a){var b=
this._exprBox.get("cursorPosition"),c=this._exprBox.get("value"),e="",g=0,f;if(this._validateExpObj(a)){this._exprStack||(this._exprStack=[]);0<this._exprStack.length&&(f=this._exprStack[this._exprStack.length-1]);b&&c||(b=[0,0]);if("operator"===a.type){var k=" "+a.value+" ";g=k.length}else"helper"===a.type?(k=a.value.name,g=-1!==a.value.name.indexOf(",")?a.value.name.indexOf(","):a.value.name.length-1):"field"===a.type&&(e=r.isDefined(f)&&"helper"===f.type&&-1!==f.value.name.indexOf("MOD")&&-1!==
h.indexOf(["esriFieldTypeBigInteger","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],a.value.type),f=r.isDefined(f)&&"helper"===f.type&&-1!==f.value.name.indexOf("MOD")&&"esriFieldTypeDouble"===a.value.type,k=this._calcField&&"esriFieldTypeDouble"===this._calcField.type&&!e&&-1!==h.indexOf(["esriFieldTypeBigInteger","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],a.value.type)?"CAST("+a.value.name+" AS FLOAT)":this._calcField&&-1!==h.indexOf(["esriFieldTypeBigInteger",
"esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],this._calcField.type)&&f?"CAST("+a.value.name+" AS INT)":a.value.name,g=k.length+1);e=c.substring(0,b[0])+k+c.substring(b[1]);this._exprBox.set("value",e);this._exprBox.focus();this._exprBox.textbox.setSelectionRange&&"number"==typeof this._exprBox.textbox.selectionStart?(this._exprBox.textbox.setSelectionRange(b[0]+g,b[0]+g),this._exprBox.set("cursorPosition",[b[0]+g,b[0]+g])):(this._setCaretPosition(this._exprBox.textbox,
b[0]+g,b[0]+g),this._exprBox.set("cursorPosition",this._getCursorRange(this._exprBox.textbox)));this._setfocus();this._exprStack.push(a)}},_setCaretPosition:function(a,b,c){a.setSelectionRange&&"number"==typeof a.selectionStart?a.setSelectionRange(b,c):"undefined"!=typeof a.createTextRange&&(a=a.createTextRange(),a.collapse(!0),a.moveEnd("character",c),a.moveStart("character",b),a.select())},_getCaretPosition:function(a){var b=0;if(K.doc.selection)a.focus(),b=K.doc.selection.createRange(),b.moveStart("character",
-a.value.length),b=b.text.length;else if(a.selectionStart||"number"==typeof a.selectionStart)b=a.selectionStart;return b},_getCursorRange:function(a){if(a.setSelectionRange&&"number"==typeof a.selectionStart){var b=a.selectionStart;var c=a.selectionEnd}else"undefined"!=typeof a.createTextRange&&(b=this._getCaretPosition(a),c=this._getCaretPosition(a));return[b,c]},_handleExpChange:function(a,b,c){this._addBtn.set("disabled",!c);this._validateBtn.set("disabled",!c);this._removeBtn.set("disabled",!c)},
_handleValidationBtnClick:function(){var a={sql:this.field+" \x3d "+this._exprBox.get("value"),sqlType:"where",f:"json"};a=B({url:this.layer.url+"/validateSQL",content:a},{usePost:!0});this._addBtn.set("disabled",!0);this._validateBtn.set("disabled",!0);this._showLoading();a.then(d.hitch(this,function(b){this._hideLoading();this._validateBtn.set("disabled",!1);this._addBtn.set("disabled",!b.isValidSQL);if(b.isValidSQL)w.toggle(this._errorMessagePane,this._css.formSuccess,!0),this._handleCloseMsg(),
this._showMessages(q.calculateFields.validExpression);else{if(b.validationErrors&&0<b.validationErrors.length){var c="";h.forEach(b.validationErrors,function(e){if(e.params&&q.calculateFields.errorCodes[e.errorCode]){var g={},f;for(f in e.params)e.params.hasOwnProperty(f)&&(g[f]=e.params[f]);c+=m.substitute(q.calculateFields.errorCodes[e.errorCode],g)+"\x3cbr/\x3e"}else c+=(q.calculateFields.errorCodes[e.errorCode]||e.description)+"\x3cbr/\x3e"},this);this._showMessages(c,!1)}else this._showMessages(q.calculateFields.invalidExpression);
w.toggle(this._errorMessagePane,this._css.formSuccess,!1)}}),d.hitch(this,function(b){this._hideLoading();this._validateBtn.set("disabled",!1);this._addBtn.set("disabled",!1)}))},_showLoading:function(){l.set(this._underlay,"display","block")},_hideLoading:function(){l.set(this._underlay,"display","none")},_getTypeLabel:function(a){if(-1!==h.indexOf(["esriFieldTypeBigInteger","esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle"],a))var b=this.i18n.integerLabel;else"esriFieldTypeDouble"===
a?b=this.i18n.doubleLabel:-1!==h.indexOf(["esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"],a)?b=this.i18n.dateLabel:"esriFieldTypeString"===a&&(b=this.i18n.stringLabel);return b},_labelFormatter:function(a){var b=m.substitute(a.functionDesc,{functionName:a.functionName})+"\x3cbr/\x3e",c=this._isRightToLeft;h.forEach(a.functionParams,function(e){b=c?b+(e.label+" - \x3ci\x3e"+e.name+"\x3c/i\x3e\x3cbr/\x3e"):b+("\x3ci\x3e"+e.name+"\x3c/i\x3e - "+e.label+
"\x3cbr/\x3e")});return b},_setLayerAttr:function(a){this._set("layer",a);this._set("fields",a.fields)},_setFieldsAttr:function(a){this._set("fields",a)},_setFieldAttr:function(a){this._set("field",a)},_setHelperMethodsAttr:function(a){this._set("helperMethods",a)},_setOperatorsAttr:function(a){this._set("operators",a)},_setShowSelectFieldAttr:function(a){this._set("showSelectField",a)},_setShowHeaderAttr:function(a){this._set("showHeader",a)},_setCloseOnAddAttr:function(a){this._set("closeOnAdd",
a)},_getExpressionAttr:function(){var a=this._exprBox.get("value");if(a){a.split(" ");var b=[];var c={field:this.field};c.sqlExpression=a;b.push(c);return this.expressionMode===p.MODE_SQL?b:this._exprBox&&this._exprBox.get("value")}this._addBtn.set("disabled",!0)},_setExpressionAttr:function(a){this._set("expression",a);this._exprBox&&this._exprBox.set("value",a)},_setAddButtonClassAttr:function(a){this._set("addButtonClass",a)},_setCloseButtonClassAttr:function(a){this._set("closeButtonClass",a)},
_setExpressionBoxRowsAttr:function(a){this.expressionBoxRows=a||4},_setExpressionBoxColsAttr:function(a){this.expressionBoxCols=a||2},_setArcadeEditorAttr:function(a){this.arcadeEditor=a},_setFieldIdAttr:function(a){this.fieldId=a},_setArcadeProfileAttr:function(a){this._set("arcadeProfile",a)},_setArcadeProfileTypeAttr:function(a){this._set("arcadeProfileType",a)}});d.mixin(p,{MODE_SQL:0,MODE_ARCADE:1});d.setObject("dijit.CalculateField",p,y);return p});