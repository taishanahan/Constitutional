//>>built
define("arcgisonline/map/dijit/toc/analysis",["dojo","dijit","dojox","dojo/require!esri/dijit/analysis/AnalysisBase,dojo/topic,dojo/Deferred,dojo/promise/all,arcgisonline/map/role,arcgisonline/map/dijit/JsonView,arcgisonline/sharing/util,esri/dijit/analysis/storageUtils,esri/dijit/analysis/JobsViewModel,esri/dijit/analysis/ItemTypes,esri/dijit/analysis/AnalysisRegistry,dojox/lang/functional/object,dojo/aspect,arcgisonline/map/main"],function(c,t,A){c.provide("arcgisonline.map.dijit.toc.analysis");
c.require("esri.dijit.analysis.AnalysisBase");c.require("dojo.topic");c.require("dojo.Deferred");c.require("dojo.promise.all");c.require("arcgisonline.map.role");c.require("arcgisonline.map.dijit.JsonView");c.require("arcgisonline.sharing.util");c.require("esri.dijit.analysis.storageUtils");c.require("esri.dijit.analysis.JobsViewModel");c.require("esri.dijit.analysis.ItemTypes");c.require("esri.dijit.analysis.AnalysisRegistry");c.require("dojox.lang.functional.object");c.require("dojo.aspect");c.require("arcgisonline.map.main");
arcgisonline.map.dijit.toc.analysis={mapLayer:null,menuSubLayerPos:null,_gpSubscribeHandlers:null,_outFeatLyrArr:[],_isKmlNetworkLinkFolder:null,_kmlFcollbycurfolder:null,_kmlAnalysisLayer:null,util:arcgisonline.sharing.util,role:arcgisonline.map.role,i18n:null,aStorageUtils:esri.dijit.analysis.storageUtils,jobsViewModel:null,DEFAULT_RESULT_LAYERNAME:"Analysis Result Layer",destroy:function(){arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers&&(c.forEach(arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers,
function(a){a.remove()}),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers=null)},buildAnalysisJobNode:function(a){var b=t.byId("tocPanel");b=!!b&&b.hasAnySubLayers;var e="",d=arcgisonline.sharing.util.relativeToExplicitUrl("js/arcgisonline/map/css/images/LoadingAnimation_circle16blue.gif");e+='\x3cdiv id\x3d"'+a.id+'" class\x3d"toc_layer'+(b?"esriLeadingMargin102":"")+' analysisJobLayer" style\x3d"width:95%;"\x3e';e=e+'\x3ctable cellpadding\x3d"0" cellspacing\x3d"0"\x3e\x3ctr\x3e\x3ctd width\x3d"9"\x3e\x3c/td\x3e\x3ctd valign\x3d"top" width\x3d"20"\x3e\x3cdiv id\x3d"'+
(a.id+'_check" class\x3d"esriFloatLeading" style\x3d"display:inline;width:17px;"\x3e\x3cinput id\x3d"'+a.id+'_checkbox" dojotype\x3d"dijit.form.CheckBox" type\x3d"checkbox" disabled\x3d\'true\'');e=e+' checked\x3d"true"/\x3e\x3c/div\x3e\x3c/td\x3e\x3ctd\x3e\x3cspan\x3e'+(A.html.entities.encode(a.title.replace(/_/g," "))+"\x3c/span\x3e");e+="\x3c/td\x3e";"raster"===a.analysisMode&&(e=e+'\x3ctd valign\x3d"top"\x3e\x3cdiv class\x3d\'esriFloatTrailing\' id\x3d"'+(a.id+"_progressDiv\" style\x3d'display:inline;opacity:1.0;z-index:1;visibility:hidden;'\x3e"),
e+="\x3c/div\x3e\x3c/td\x3e");e=e+'\x3ctd class\x3d"esriFloatTrailing esriLeadingMargin05 esriTrailingMargin05" style\x3d\'\' valign\x3d"top"\x3e\x3cimg src\x3d'+(d+" height\x3d'16' width\x3d'16' id\x3d\""+a.id+'_loadingDiv"\x3e');e=e+'\x3c/td\x3e\x3ctd valign\x3d"top"\x3e\x3cdiv class\x3d\'esriFloatTrailing\' id\x3d"'+(a.id+"_cancelDiv\" style\x3d'display:inline;opacity:1.0;z-index:1;visibility:hidden;'\x3e");if(a.isCancel||-1===c.indexOf("TraceDownstream CreateWatersheds CreateViewshed CreateDriveTimeAreas EnrichLayer SummarizeNearby FindNearest PlanRoutes ChooseBestFacilities".split(" "),
a.toolName)||"SummarizeNearby"===a.toolName&&"StraightLine"===a.jobParams.nearType||("FindNearest"===a.toolName||"ConnectOriginsToDestinations"===a.toolName)&&"StraightLine"===a.jobParams.measurementType)e+="\x3ca href\x3d\"JavaScript:dijit.byId('tocPanel').cancelAnalysis('"+a.id+"');\" title\x3d'"+esri.i18nBundle.tocPanel.cancelAnalysis+'\'\x3e\x3cimg src\x3d"images/close.gif" border\x3d"0"/\x3e\x3c/a\x3e',a.isCancel=!0;e=e+'\x3c/div\x3e\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e\x3c/div\x3e\x3cdiv id\x3d"'+
(a.id+'_sub" class\x3d"toc_toggle_layer" style\x3d"display:none;"\x3e');return e+"\x3c/div\x3e"},cancelAnalysis:function(a){arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].tool.cancel(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].jobInfo),c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a])},checkAnalysisJobs:function(){this.i18n||(this.i18n={},this.i18n=
c.i18n.getLocalization("arcgisonline","arcgisonline").common,c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel),c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").analysisTool));this._setAnalysisHandlers();if(esri.isDefined(this._outFeatLyrArr))for(var a in this._outFeatLyrArr)if(this._outFeatLyrArr.hasOwnProperty(a)){var b=this._outFeatLyrArr[a],e=this.getGpServer(b.analysisMode);esri.isDefined(b)&&(e=new esri.dijit.analysis.AnalysisBase({analysisGpServer:e,
toolName:b.toolName,toolServiceUrl:e+"/"+b.toolName,getResultLyrInfos:b.jobInfo.getResultLyrInfos,resultParameter:b.jobInfo.resultParameter,jobParams:b.jobInfo,currentGpItemId:b.jobInfo.currentGpItemId,itemParams:b.jobInfo.itemParams}),this._loadConnections(e),b.jobInfo&&b.jobInfo.jobId&&e.checkJobStatus(b.jobInfo.jobId),esri.isDefined(this._outFeatLyrArr[a].tool)||(this._outFeatLyrArr[a].tool=e))}},_loadConnections:function(a){a.on("close",c.hitch(this,this._onClose));a.on("start",c.hitch(this,function(b){var e=
{};e=c.mixin({},b);e.tool=a;e.analysisMode=b.analysisMode;arcgisonline.map.dijit.toc.analysis.setToolWarningMessages();if(a.map){b=a.get("drawLayer");var d=[];b instanceof Array?d=b:d.push(b);c.forEach(d,function(f,g){f&&(f={layer:f,id:f.id,type:"user",title:f.name,defaultVisibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,identify:!1},g=arcgisonline.map.layer.getLayerPosition(f),arcgisonline.map.main.mapLayers.splice(g.list,0,f),g=g.map,arcgisonline.map.main.map.removeLayer(f.layer),arcgisonline.map.main.map.addLayer(f.layer,
g,function(){c.publish("onLayerUpdate",[""])}))})}c.topic.publish("Analysis/OnExecute",e)}));a.on("job-submit",c.hitch(this,function(b){c.topic.publish("Analysis/OnJobSubmit",b)}));a.on("job-status",c.hitch(this,function(b){c.topic.publish("Analysis/OnJobStatus",b)}));a.on("job-result",c.hitch(this,function(b){c.topic.publish("Analysis/OnJobResult",b)}));a.on("job-success",c.hitch(this,function(b){c.topic.publish("Analysis/OnJobSuccess",b)}));a.on("job-fail",c.hitch(this,function(b){var e="";b.message&&
(e=b.message);"warning"===b.type&&a.set("disableRunAnalysis",!1);arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:this.i18n.errorTitle,message:e});c.topic.publish("Analysis/OnJobFailed",b)}));a.on("job-cancel",c.hitch(this,function(b){c.topic.publish("Analysis/OnJobCancel",b)}))},getGpServer:function(a){var b="";a||(a="standard");esriGeowConfig.isAnalysisDebugServer?b=esriGeowConfig.analysisDebugServerUrl:a&&"standard"!==a?"bigdata"===a?b=esriGeowConfig.self.helperServices.geoanalytics&&
esriGeowConfig.self.helperServices.geoanalytics.url?esriGeowConfig.self.helperServices.geoanalytics.url:null:"raster"===a&&(b=esriGeowConfig.self.helperServices.rasterAnalytics&&esriGeowConfig.self.helperServices.rasterAnalytics.url?esriGeowConfig.self.helperServices.rasterAnalytics.url:null):b=esriGeowConfig.self.helperServices.analysis&&esriGeowConfig.self.helperServices.analysis.url?esriGeowConfig.self.helperServices.analysis.url:null;return b},isPerformAnalysisLayer:function(a,b){var e=arcgisonline.map.featColl.isFeatureCollection(a),
d="mapNotes"===a.type,f=a.layer instanceof esri.layers.FeatureLayer&&esri.isDefined(a.layer.geometryType)&&!(a.layer instanceof esri.layers.StreamLayer),g=a.layer instanceof esri.layers.FeatureLayer&&a.layer.type&&"table"===a.layer.type.toLowerCase(),l=a.layer instanceof esri.layers.GeoRSSLayer,k=a.layer instanceof esri.layers.CSVLayer;b=e&&!d&&-1!==b;var m=a.layer instanceof esri.layers.WFSLayer,n=!this.util.isPortal()&&esri.isDefined(a.analysisProxyCheck)?"failure"===a.analysisProxyCheck:!1;a=a.itemCard&&
a.itemCard.typeKeywords&&-1!==a.itemCard.typeKeywords.indexOf("Location Tracking Service");return(f||g||e&&b||l||k||d||m)&&!n&&!a},getRunningJobs:function(){return this._outFeatLyrArr},getToolWarningMessages:function(){return this._warnings},updateToolWarningMessages:function(a){this._warnings||(this._warnings=[]);return this._warnings.push(a)},setToolWarningMessages:function(a){this._warnings||(this._warnings=a||[])},clearToolWarningMessages:function(){this._warnings=null},getJobsList:function(){var a=
[],b;if(esri.isDefined(this._outFeatLyrArr))for(var e in this._outFeatLyrArr)if(this._outFeatLyrArr.hasOwnProperty(e)&&(b=this._outFeatLyrArr[e])&&b.jobInfo&&b.jobInfo.jobId){var d={id:b.id,title:b.title,toolName:b.toolName,analysisMode:b.analysisMode,jobInfo:{jobId:b.jobInfo.jobId,resultParameter:b.jobInfo.resultParameter,returnProcessInfo:b.jobInfo.returnProcessInfo,getResultLyrInfos:b.jobInfo.getResultLyrInfos,OutputName:b.jobInfo.jobParams.OutputName,currentGpItemId:b.jobInfo.currentGpItemId,
itemParams:b.jobInfo.itemParams},isCancel:b.isCancel};b.jobInfo.jobParams.actualOutputName&&(d.jobInfo.OutputName=b.jobInfo.jobParams[b.jobInfo.jobParams.actualOutputName]);a.push(d)}return a},setJobsList:function(a){this._outFeatLyrArr=[];c.forEach(a,c.hitch(this,function(b,e){this._outFeatLyrArr[b.id]=b}))},isAnalysisLayer:function(a){var b=arcgisonline.map.featColl.isFeatureCollection(a),e="mapNotes"===a.type,d=a.layer instanceof esri.layers.FeatureLayer&&!(a.layer instanceof esri.layers.StreamLayer),
f=a.layer instanceof esri.layers.ArcGISImageServiceLayer||a.layer instanceof esri.layers.RasterXLayer,g=a.layer instanceof esri.layers.ArcGISImageServiceVectorLayer,l=a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer,k="base"===a.type||"labels"===a.type,m=a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer,n=a.layer instanceof esri.layers.GeoRSSLayer,u=a.layer instanceof esri.layers.CSVLayer,h=b&&!e,v=arcgisonline.map.main.hasDynamicLayers(a)&&a.thematicGroup,r=a.layer instanceof esri.layers.KMLLayer&&
arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer,q=a.layer instanceof esri.layers.WFSLayer,z=!this.util.isPortal()&&esri.isDefined(a.analysisProxyCheck)?"failure"===a.analysisProxyCheck:!1;a=a.itemCard&&a.itemCard.typeKeywords&&-1!==a.itemCard.typeKeywords.indexOf("Location Tracking Service");return(d||f||g||b||n||u||h||m||l||e||r||q)&&!k&&!v&&!z&&!a},hasShapeField:function(a){return a.fields&&0<a.fields.length?c.some(a.fields,function(b){return b&&"esriFieldTypeGeometry"===b.type?!0:!1},this):
!1},addToLivingAtlasFeatureLayers:function(a){this.isLivingAtlasLayer(a)&&(this._LALayers||(this._LALayers=[]),this._LALayers.push(a.layer))},isLivingAtlasLayer:function(a){return!!a.itemCard&&!!a.itemCard.groupDesignations&&"livingatlas"===a.itemCard.groupDesignations},isAnalysisRestrictedLALayer:function(a){return this.isLivingAtlasLayer(a)&&a.itemCard.typeKeywords&&-1!==a.itemCard.typeKeywords.indexOf("AnalysisRestricted")},isLayerInLivingAtlasFeatureLayers:function(a){var b=[];if(!a||!a.url)return!1;
this._LALayers&&0<this._LALayers.length&&(b=this._LALayers.map(function(e){return e.url}));return-1!==b.indexOf(a.url)},isPortalHostedService:function(a){var b=arcgisonline.sharing.util.getUser(),e=arcgisonline.sharing.util.portalSupportsHostedServices(),d=a.itemCard;a=a.itemId;return b&&e&&a&&d&&d.typeKeywords&&-1<c.indexOf(d.typeKeywords,"Hosted Service")},_getFlayers:function(a,b){if(b){b=c.mixin({},b);var e=[],d=!0;c.forEach(b.layers,function(f,g){if("Feature Layer"===f.type){d=arcgisonline.map.dijit.toc.analysis.hasShapeField(f)||
a.queryServiceUrl;var l;!d&&a.itemLayers&&c.forEach(a.itemLayers,function(m){m.id===f.id&&m.layerUrl&&arcgisonline.sharing.util.isHostedService(m.layerUrl)&&(d=!0,l=m.layerUrl)});f._isAnalysisSubLayer=g===arcgisonline.map.dijit.toc.analysis.menuSubLayerPos;if(f.capabilities&&f.capabilities.toLowerCase&&-1!==f.capabilities.toLowerCase().indexOf("query")&&f.geometryType&&d){f.url=l?l:a.queryLayersInfo?a.queryServiceUrl+"/"+f.id:a.url+"/"+f.id;a.layer.credential&&(f.credential=a.layer.credential);esri.isDefined(a.layer.layerDefinitions)&&
a.layer.layerDefinitions[f.id]&&(f.definitionExpression=a.layer.layerDefinitions[f.id]);var k=new esri.layers.FeatureLayer(f.url,{mode:esri.layers.FeatureLayer.MODE_SNAPSHOT});k._isAnalysisSubLayer=f._isAnalysisSubLayer;a.itemLayers&&a.itemLayers[g]&&a.itemLayers[g].layerDefinition&&a.itemLayers[g].layerDefinition.drawingInfo&&a.itemLayers[g].layerDefinition.drawingInfo.labelingInfo&&(k.labelingInfo=a.itemLayers[g].layerDefinition.drawingInfo.labelingInfo,k.showLabels=a.itemLayers[g].layerDefinition.drawingInfo.showLabels);
esri.isDefined(f.credential)&&(k.credential=f.credential);esri.isDefined(f.definitionExpression)&&(k.definitionExpression=f.definitionExpression);a.layer.getMap()&&(k._map=a.layer.getMap());f.timeInfo&&f.useStandardizedQueries&&(k._useStandardizedQueries=f.useStandardizedQueries);e.push(k)}}});return e}},_getLayers:function(a){var b=new c.Deferred;if(arcgisonline.map.dijit.toc.analysis.isMS(a))if(a.queryServiceUrl)a.queryServiceUrl&&(a.queryLayersInfo?(a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,
a.queryLayersInfo),b.resolve(a)):arcgisonline.map.main.getQueryLayersInfo(a,function(d){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,d);b.resolve(a)}));else if(!a.layersInfo||a.itemLayers&&0!==a.itemLayers.length)if(a.itemLayers&&0<a.itemLayers.length){var e=[];c.forEach(a.itemLayers,function(d){if(d._layerInfo){var f=c.mixin({},d._layerInfo);f.url=d.layerUrl;e.push(f)}});0<e.length?(a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,{layers:e}),b.resolve(a)):arcgisonline.map.main.getLayersInfo(a,
function(d){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,d);b.resolve(a)})}else arcgisonline.map.main.getLayersInfo(a,function(d){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,d);b.resolve(a)});else a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,a.layersInfo),b.resolve(a);else b.resolve(a);return b},_getServiceName:function(a){var b=c.fromJson(a[a.actualOutputName||"OutputName"]);return b&&b.serviceProperties?b.serviceProperties.name:a.resultName||this.DEFAULT_RESULT_LAYERNAME},
configureAnalysis:function(a,b){var e=[],d,f;arcgisonline.map.dijit.toc.analysis.isCustomGP=!1;arcgisonline.map.dijit.toc.analysis.customGPType=null;a&&a.target&&this._lastTarget!==a.target&&(this._lastTarget=a.target,b.reopenAnalysisPanel=!0);(!esri.isDefined(b)||esri.isDefined(b)&&!b.isMenu)&&t.byId("webmap-analysis").set("checked",!0);arcgisonline.map.dijit.toc.analysis.i18n||(arcgisonline.map.dijit.toc.analysis.i18n={},arcgisonline.map.dijit.toc.analysis.i18n=c.i18n.getLocalization("arcgisonline",
"arcgisonline").common,c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel),c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").analysisTool));b&&"GPWidget"===b.toolName&&(f=b);b&&!b.isMenu?(arcgisonline.map.dijit.toc.analysis.mapLayer=b.mapLayer,arcgisonline.map.dijit.toc.analysis.menuSubLayerPos=b.menuSubLayerPos,arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder=b.isKmlNetworkLinkFolder,arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder=
b.kmlFcollbycurfolder,arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer=b.kmlAnalysisLayer):b&&b.isMenu&&arcgisonline.map.dijit.toc.analysis.clear();var g=arcgisonline.map.main.mapLayers.slice(0);0<arcgisonline.map.main.mapTables.length&&(g=g.concat(arcgisonline.map.main.mapTables.slice(0)));if(a&&a.analysisType)var l=a.analysisType;esri.isDefined(arcgisonline.map.main.analysisProps.selectedFolder)||(arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.ownerFolder?arcgisonline.map.main.analysisProps.selectedFolder=
arcgisonline.map.save_open.webMapInfo.ownerFolder:c.cookie("ESRI_Content")&&c.fromJson(c.cookie("ESRI_Content")).folderId&&(arcgisonline.map.main.analysisProps.selectedFolder=c.fromJson(c.cookie("ESRI_Content")).folderId));if(arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder){var k={};k.layer=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer;k.id=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.id;k.title=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.title;var m=k;g.push(m)}else m=
arcgisonline.map.dijit.toc.analysis.mapLayer;arcgisonline.map.dijit.toc.analysis._setAnalysisHandlers();var n=[];c.forEach(g,function(u,h){arcgisonline.map.dijit.toc.analysis.isAnalysisLayer(u)&&n.push(arcgisonline.map.dijit.toc.analysis._getLayers(u))});(new c.promise.all(n)).then(c.hitch(this,function(u){e=c.mixin([],u.reverse());c.forEach(u,function(h){m&&h.id===m.id&&(d=h)});c.forEach(e,function(h,v){var r=arcgisonline.sharing.util.getUser(),q="mapNotes"===h.type,z=h.layer instanceof esri.layers.GeoRSSLayer,
C=h.layer instanceof esri.layers.CSVLayer,B=arcgisonline.map.featColl.isFeatureCollection(h)&&!q,y=arcgisonline.sharing.util.isPortal();if(arcgisonline.map.dijit.toc.analysis.isHostedFeatureLayer(h)){this.addToLivingAtlasFeatureLayers(h);r&&h.itemCard&&h.itemCard.owner&&h.itemCard.owner===r.username&&h.layer&&(h.layer.userId=r.username);if(h.layer&&h.layer.fields){var D=arcgisonline.map.popup.getPopupInfo(h,null);c.forEach(h.layer.fields,function(p){p.alias=arcgisonline.map.dijit.toc.analysis.getLabelFromPopup(D,
p.name)||p.alias})}z||C?(h.userIsAdmin=!0,h.layer.capabilities?-1===h.layer.capabilities.indexOf("Extract")&&(h.layer.capabilities+=",Extract"):h.layer.capabilities="Extract"):q||B?(h.userIsAdmin=!0,h.layers&&0<h.layers.length?h.layers=c.map(h.layers,function(p){p.capabilities?-1===p.capabilities.indexOf("Extract")&&(p.capabilities+=",Extract"):p.capabilities="Extract";return p}):(h.userIsAdmin=!0,h.layer.capabilities?-1===h.layer.capabilities.indexOf("Extract")&&(h.layer.capabilities+=",Extract"):
h.layer.capabilities="Extract")):esriGeowConfig.userRole.isAdmin()&&(y&&h.itemCard&&h.itemCard.itemControl&&"admin"===h.itemCard.itemControl||!y&&h.url&&-1<h.url.indexOf("/"+r.accountId+"/"))?(h.userIsAdmin=!0,h.layer.capabilities?-1===h.layer.capabilities.indexOf("Extract")&&(h.layer.capabilities+=",Extract"):h.layer.capabilities="Extract"):r&&h.itemCard&&h.itemCard.owner&&h.itemCard.owner===r.username&&(!y&&-1<h.url.indexOf("/"+r.accountId+"/")||y)&&(h.userIsAdmin=!0,h.layer.capabilities?-1===h.layer.capabilities.indexOf("Extract")&&
(h.layer.capabilities+=",Extract"):h.layer.capabilities="Extract");d&&d.id===h.id&&(d=c.mixin({},h),B&&d.layers&&0<d.layers.length&&(d.layer=d.layers[arcgisonline.map.dijit.toc.analysis.menuSubLayerPos],delete d.layers))}else if(h.layer instanceof esri.layers.KMLLayer&&arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder&&0<arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder.length&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.id===
h.id){var w=[];c.forEach(arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder,function(p,x){p=new esri.layers.FeatureLayer(c.clone(p),{mode:esri.layers.FeatureLayer.MODE_SNAPSHOT});arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder?(p.name=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.name,p.id=h.id):(x=h.layer.folders[arcgisonline.map.dijit.toc.analysis.menuSubLayerPos],p.name=h.title+"_"+x.name,p.id=x.name);w.push(p)});c.forEach(w,function(p,x){1<w.length&&p.geometryType===
l&&d.id===h.id?(d={},d.layer=p,d.title=p.name,h=d,e.splice(v,1,d)):d.id===h.id&&0===x&&(d={},d.layer=w[0],d.title=w[0].name,h=d,e.splice(v,1,d))})}else h.layer instanceof esri.layers.WFSLayer&&(r=arcgisonline.map.wfs.createFeatureCollectionJson(h),r=new esri.layers.FeatureLayer(r,{mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["*"]}),q={},q.layer=r,q.title=h.title,q.userIsAdmin=!0,q.layer.capabilities?-1===q.layer.capabilities.indexOf("Extract")&&(q.layer.capabilities+=",Extract"):q.layer.capabilities=
"Extract",e.splice(v,1,q),d&&h.id===d.id&&(d=q))},this);arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder&&0<arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder.length&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer&&(e=c.filter(e,function(h){return!(h.layer instanceof esri.layers.KMLLayer)}));b={analysisLayer:d,featureLayers:e,openAnalysisHistoryPanel:b&&b.openAnalysisHistoryPanel&&!b.rerunItem,reopenAnalysisPanel:b&&b.reopenAnalysisPanel,rerunItem:b&&b.rerunItem};l&&(b.analysisType=
l);a&&a.showSelectedCategory&&(b.showSelectedCategory=a.showSelectedCategory);a&&a.analysisMode&&(b.analysisMode=a.analysisMode);a&&a.selectedPanel&&(b.selectedPanel=a.selectedPanel);b.rerunItem?this.initContextRerun(b,d):f&&"GPWidget"===f.toolName?(c.mixin(b,f),arcgisonline.map.dijit.toc.analysis.isCustomGP=!0,arcgisonline.map.dijit.toc.analysis.customGPType=b.taskUrl?"url":"item",this.initCustomGP(b)):arcgisonline.map.leftPanel.openLeftAnalysisPanel(b)}))},_handleShowAnalysis:function(a){a&&a.openAnalysisHistoryPanel?
(a.isMenu=!0,this.configureAnalysisHistory(null,a)):this.configureAnalysis(a)},_handleAnalysisJobExceute:function(a){var b=this._getServiceName(a),e={id:b,title:b,name:b,toolName:a.tool.toolName,jobParams:a.tool.jobParams,pos:arcgisonline.map.main.mapLayers.length+1,isCancel:!1,analysisMode:a.analysisMode};if(!a.isWebTool||a.addToMap){var d=arcgisonline.map.dijit.toc.analysis.buildAnalysisJobNode(e),f=c.byId("toc-main");arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[b]=e;arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[b].tool=
a.tool;arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[b].analysisMode=a.analysisMode;f&&c.place(d,f,"first")}},_handleAnalysisJobSubmit:function(a){if(!a.isWebTool||a.addToMap)a=this._getServiceName(a),c.byId(a+"_cancelDiv")&&c.style(c.byId(a+"_cancelDiv"),"visibility","visible")},_handleAnalysisJobStatus:function(a){var b=a.jobParams;if(!a.isWebTool||a.addToMap){var e=this._getServiceName(b);if(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e])if(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e].jobInfo=
a,c.byId(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e].id)){if(c.byId(e+"_cancelDiv")){var d=!1,f=!1;a.jobStatus&&(d=-1===c.indexOf(["esriJobCancelled","esriJobFailed","esriJobSucceeded"],a.jobStatus));(f=!!b.outputType&&b.outputType===esri.dijit.analysis.ItemTypes.FLAYERVIEW)&&(d=!f);c.style(c.byId(e+"_cancelDiv"),"visibility",d?"visible":"hidden")}if(c.byId(e+"_progressDiv")){b=!1;c.attr(c.byId(e+"_progressDiv"),"innerHTML","");c.attr(c.byId(e+"_loadingDiv"),"title","");if(a.jobStatus&&
(b=-1===c.indexOf(["esriJobCancelled","esriJobFailed","esriJobSucceeded"],a.jobStatus)&&a.progress&&0<=a.progress.percent&&100>=a.progress.percent)){0<a.progress.percent&&c.attr(c.byId(e+"_progressDiv"),"innerHTML",c.string.substitute(esri.i18nBundle.tocPanel.percentValue,{num:a.progress.percent}));var g=a.progress.message;g&&"Executing;Generate Raster;Building pyramid;Converting raster to polygons;Getting observer elevations;Subdividing observers;Calculating statistics;Rasterizing polygon features;Reading input envelopes;Final selection;Converting raster to polylines;Converting raster to points;Calculating geodesic kernel density;Exporting to;Compute statistics and histogram".split(";").forEach(function(l,
k){0===g.indexOf(l)&&(l=l.replace(/ /g,"").toLowerCase(),c.attr(c.byId(e+"_loadingDiv"),"title",esri.i18nBundle.tocPanel.gpMsg[l]))})}c.style(c.byId(e+"_progressDiv"),"visibility",b?"visible":"hidden")}}else arcgisonline.map.dijit.toc.analysis.buildAnalysisJobNode(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]);if("esriJobFailed"===a.jobStatus||"esriJobTimedOut"===a.jobStatus)g="",a.message?g=a.message:a.message||"esriJobTimedOut"!==a.jobStatus||(g=this.i18n&&this.i18n.timedOutMsg?this.i18n.timedOutMsg:
esri.i18nBundle.analysisTool.timedOutMsg),arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:esri.i18nBundle.common.errorTitle,message:g}),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e].id),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]);"warning"===a.type&&a.message&&arcgisonline.map.dijit.toc.analysis.updateToolWarningMessages(a.message)}},_handleAnalysisJobCancel:function(a){if(!a.isWebTool||
a.addToMap)a=this._getServiceName(a.jobParams),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a],arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.infoTitle,message:this.i18n.cancelMsg}))},_handleAnalysisJobResult:function(a){var b=a.value,e=a.outputLayerName||this.DEFAULT_RESULT_LAYERNAME;if(!a.isWebTool||a.addToMap){arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]&&
(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e].id),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[e]);var d=c.connect(arcgisonline.map.main.map,"onLayerAdd",c.hitch(this,function(l){var k=arcgisonline.map.dijit.toc.analysis.getToolWarningMessages();c.disconnect(d);esri.isDefined(k)&&0<k.length&&(arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:arcgisonline.map.dijit.toc.analysis.i18n.warning,message:k}),
arcgisonline.map.dijit.toc.analysis.clearToolWarningMessages());(k=arcgisonline.map.main.getParameterList(l))&&b.itemId&&arcgisonline.map.thumbnail.recreateItemThumbnail(k);l.timeInfo&&(l.setUseMapTime(!0),arcgisonline.map.time.checkOnTimeButton());!k.popupInfo&&k.serviceInfo&&(k.popupInfo=arcgisonline.map.popup.getDefaultPopupInfo(k.serviceInfo,!1,l),arcgisonline.map.mapUtil.setInfoTemplate(l,k.popupInfo),k.popupChanged=!0)}));if(b.itemId)arcgisonline.map.save_open.openServiceItemCards(b.itemId);
else if(b.url)arcgisonline.map.save_open.addServiceByUrl(b.url,{title:e});else if(b.featureSet&&!b.featureSet.exceededTransferLimit&&b.featureSet.features&&0<b.featureSet.features.length){var f={layers:[]},g=b;g.popupInfo||(g.popupInfo=arcgisonline.map.featColl.generateDefaultPopupInfo(g));f.layers.push(g);f=arcgisonline.map.featColl.addFeatureLayers({featureCollection:f,title:e});(f=arcgisonline.map.featColl.getFullExtent(f))&&arcgisonline.map.main.map.setExtent(f,!0)}else a.results&&0<a.results.length?
(c.forEach(a.results,function(l,k){var m={layers:[]},n=l.value;n.featureSet.spatialReference=n.layerDefinition.spatialReference;n.popupInfo||(n.popupInfo=arcgisonline.map.featColl.generateDefaultPopupInfo(n));m.layers.push(n);arcgisonline.map.featColl.addFeatureLayers({featureCollection:m,title:0===k?e:e+"_"+l.paramName})},this),c.publish("onLayerUpdate",[""])):b.features&&0<b.features.length&&(g=a.param,f={layers:[]},g={layerDefinition:g.defaultValue,featureSet:{geometryType:g.defaultValue&&g.defaultValue.geometryType,
features:b.features,spatialReference:g.defaultValue&&g.defaultValue.spatialReference}},g.popupInfo||(g.popupInfo=arcgisonline.map.featColl.generateDefaultPopupInfo(g)),f.layers.push(g),f=arcgisonline.map.featColl.addFeatureLayers({featureCollection:f},e),(f=arcgisonline.map.featColl.getFullExtent(f))&&arcgisonline.map.main.map.setExtent(f,!0));a.analysisInfo&&a.analysisInfo.secondaryOutputs&&c.forEach(a.analysisInfo.secondaryOutputs,c.hitch(this,function(l){c.forEach(a.results,c.hitch(this,function(k){k.paramName===
l&&k.value.itemId&&arcgisonline.map.save_open.openServiceItemCards(k.value.itemId)}))}))}},_handleAnalysisJobFailed:function(a){a&&a.jobParams&&(a=this._getServiceName(a.jobParams),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]))},saveJobs:function(a){if(esriGeowConfig.showAnalysisHistory){var b={portalUrl:esriGeowConfig.restBaseUrl.substring(0,
esriGeowConfig.restBaseUrl.indexOf("/sharing/rest"))};this.aStorageUtils.saveJobsInfoList(a,b).then(c.hitch(this,function(e){e.item=a;c.topic.publish("Analysis/OnJobHistorySave",e)}))}},_handleWebMapSave:function(a){arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.id===a&&this.saveJobs(arcgisonline.map.save_open.webMapInfo)},getResourceInfo:function(a){var b={portalUrl:esriGeowConfig.restBaseUrl.substring(0,esriGeowConfig.restBaseUrl.indexOf("/sharing/rest"))},e=new c.Deferred;
this.aStorageUtils.getResources(a,b).then(c.hitch(this,function(d){e.resolve({showRerun:d&&0<d.total,showJobResultPopup:!!this.isResultPopupPresent(d.resources)||this.isProcessInfoPresent(a.properties.jobUrl),popup:this.isResultPopupPresent(d.resources)})}),c.hitch(this,function(d){e.resolve({showRerun:!1,showJobResultPopup:!1})}));return e.promise},isResultPopupPresent:function(a){var b=void 0;if(!a||2>a.length)return b;a.forEach(function(e){"dataset_statistics.json"===e.resource&&(b=e.resource)});
return b},isProcessInfoPresent:function(a){return A.lang.functional.object.values(esri.dijit.analysis.AnalysisRegistry.ProcessInfoTools).some(function(b){var e=-1!==a.indexOf(b.Name);if(arcgisonline.sharing.util.isPortal())-1!==a.indexOf(esri.dijit.analysis.AnalysisRegistry.ToolCategory.Std)?d=b.Std:-1!==a.indexOf(esri.dijit.analysis.AnalysisRegistry.ToolCategory.Gax)&&(d=b.Gax);else var d=b.Std;return e&&d})},generateProcessInfoTable:function(a){a=a.replace("\x3cb\x3e","\x3cdiv class\x3d'esriProcessInfoTitle'\x3e").replace("\x3c/b\x3e",
"\x3c/div\x3e");return"\x3cdiv class\x3d'esriProcessInfoCtr'\x3e"+a+"\x3c/div\x3e"},showAnalysisResultPopup:function(a,b){var e={portalUrl:esriGeowConfig.restBaseUrl.substring(0,esriGeowConfig.restBaseUrl.indexOf("/sharing/rest")),resource:b},d={baseTabs:[],selectedTab:void 0};this.isProcessInfoPresent(a.properties.jobUrl)&&(d.selectedTab="ProcessInfo",d.baseTabs.push("ProcessInfo"),d.processInfoHtml=this.generateProcessInfoTable(a.description));b?(d.selectedTab=d.selectedTab||"Json",d.baseTabs.push("Json"),
this.aStorageUtils.getItemResource(a,e).then(function(f){delete f._ssl;d.data=f;new arcgisonline.map.dijit.JsonView(d)},function(f){d.data=f;new arcgisonline.map.dijit.JsonView(d)})):new arcgisonline.map.dijit.JsonView(d)},_setAnalysisHandlers:function(){arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers||(arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers=[],arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/ShowAnalysis",c.hitch(arcgisonline.map.dijit.toc.analysis,
"_handleShowAnalysis"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnExecute",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobExceute"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobSubmit",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobSubmit"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobStatus",c.hitch(arcgisonline.map.dijit.toc.analysis,
"_handleAnalysisJobStatus"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobResult",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobResult"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobFailed",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobFailed"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobCancel",c.hitch(arcgisonline.map.dijit.toc.analysis,
"_handleAnalysisJobCancel"))))},_setSaveJobsHandlers:function(){this._setSaveHandler||(c.subscribe("onWebMapSave",null,c.hitch(this,this._handleWebMapSave)),c.subscribe("onSaveExistingWebMap",null,c.hitch(this,this._handleWebMapSave)),this._setSaveHandler=!0)},getLabelFromPopup:function(a,b){if(a&&a.fieldInfos&&0<a.fieldInfos.length)for(var e=0;e<a.fieldInfos.length;e++){var d=a.fieldInfos[e];if(d.fieldName==b)return d.label}return null},getOutFeatLyrArr:function(){return arcgisonline.map.dijit.toc.analysis._outFeatLyrArr},
isHostedFeatureLayer:function(a){var b=arcgisonline.map.featColl.isFeatureCollection(a),e="mapNotes"===a.type,d="base"===a.type||"labels"===a.type,f=a.layer instanceof esri.layers.GeoRSSLayer,g=a.layer instanceof esri.layers.CSVLayer;return(a.layer instanceof esri.layers.FeatureLayer&&!(a.layer instanceof esri.layers.StreamLayer)||b||f||g||e)&&!d},isMS:function(a){var b=a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer,e=a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer,d=arcgisonline.map.main.hasDynamicLayers(a),
f="base"===a.type||"labels"===a.type;a=d&&a.thematicGroup;return(e||b)&&!a&&!f},checkLayers:function(){if(arcgisonline.map.dijit.toc.analysis.proxyCheckPromise)return arcgisonline.map.dijit.toc.analysis.proxyCheckPromise;if(arcgisonline.sharing.util.isPortal()||esri.isDefined(esriGeowConfig.self)&&"singletenant"===esriGeowConfig.self.portalMode||!esriGeowConfig.isMultiTenant){var a=new c.Deferred;arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=a.promise;a.resolve({success:!0})}else{a=new c.Deferred;
arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=a.promise;var b=[];if(0<arcgisonline.map.main.mapLayers.length)for(var e=0;e<arcgisonline.map.main.mapLayers.length;e++){var d=arcgisonline.map.main.mapLayers[e];"user"!==d.type||!d.url||arcgisonline.map.featColl.isFeatureCollection(d)||arcgisonline.sharing.util.isHostedService(d.url)||this.isPortalHostedService(d)||d.layer instanceof esri.layers.CSVLayer||!(d.layer instanceof esri.layers.FeatureLayer||arcgisonline.map.dijit.toc.analysis.isMS(d))||
d.analysisProxyCheck||d._checkingProxy||(b.push(this._getProxyServiceInfo(e,arcgisonline.map.main.mapLayers)),d._checkingProxy=!0)}if(0<arcgisonline.map.main.mapTables.length)for(e=0;e<arcgisonline.map.main.mapTables.length;e++)d=arcgisonline.map.main.mapTables[e],!d.url||arcgisonline.map.featColl.isFeatureCollection(d)||arcgisonline.sharing.util.isHostedService(d.url)||this.isPortalHostedService(d)||d.layer instanceof esri.layers.CSVLayer||!(d.layer instanceof esri.layers.FeatureLayer||arcgisonline.map.dijit.toc.analysis.isMS(d))||
d.analysisProxyCheck||d._checkingProxy||(b.push(this._getProxyServiceInfo(e,arcgisonline.map.main.mapTables)),d._checkingProxy=!0);0===b.length?(a.resolve({success:!0}),arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=null):c.promise.all(b).then(c.hitch(this,function(f){a.resolve(f);arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=null}),c.hitch(this,function(f){a.resolve(f);arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=null}))}return a.promise},_getProxyServiceInfo:function(a,b){var e=
new c.Deferred,d=b[a],f;esri.isDefined(d)&&esri.isDefined(d.layer)&&esri.isDefined(d.layer.url)||e.reject({error:"mapLayer is not defined"});a=d.layer.url+(-1<d.layer.url.indexOf("?")?"\x26":"?")+"f\x3djson";d.layer._findCredential();b=d.layer._getToken();var g=d.layer.url;arcgisonline.map.dijit.toc.analysis.proxyCheckedServers||(arcgisonline.map.dijit.toc.analysis.proxyCheckedServers=[]);c.some(arcgisonline.map.dijit.toc.analysis.proxyCheckedServers,function(l){f=g.substring(0,g.indexOf("/",9));
if(l.server===f)return d.analysisProxyCheck=l.check,!0},this)?e.resolve({}):(b&&(a+="\x26token\x3d"+b),e=esri.request({url:a,content:null},{useProxy:!0}),e.then(c.hitch(this,function(){d.analysisProxyCheck="success";arcgisonline.map.dijit.toc.analysis.proxyCheckedServers.push({server:g.substring(0,g.indexOf("/",9)),check:"success"})}),c.hitch(this,function(){d.analysisProxyCheck="failure";arcgisonline.map.dijit.toc.analysis.proxyCheckedServers.push({server:g.substring(0,g.indexOf("/",9)),check:"failure"})})));
return e.promise},canPerformAnalysis:function(){var a=!1;esri.isDefined(this.role.userActions)?a=!0===this.role.isAllowed("toc_menu_analysis"):!arcgisonline.map.dijit.toc.analysis.role.isAnonymous()&&esri.isDefined(esriGeowConfig.userRole)&&(a=arcgisonline.sharing.util.isPortal()?esriGeowConfig.userRole.canPublishFeatures()&&(esriGeowConfig.userRole.canUseSpatialAnalysis()||esriGeowConfig.userRole.canUseRasterAnalysis()||esriGeowConfig.userRole.canUseGeoanalytics()):esriGeowConfig.userRole.canPublishFeatures()&&
(esriGeowConfig.userRole.canUseSpatialAnalysis()||esriGeowConfig.userRole.canUseRasterAnalysis()));return a},canPerformSpatialAnalytics:function(){var a=!1,b=esri.isDefined(esriGeowConfig.self.helperServices.analysis)&&esri.isDefined(esriGeowConfig.self.helperServices.analysis.url),e=this.util.isPortal();!arcgisonline.map.dijit.toc.analysis.role.isAnonymous()&&esri.isDefined(esriGeowConfig.userRole)&&(a=esriGeowConfig.userRole.canPublishFeatures()&&esriGeowConfig.userRole.canUseSpatialAnalysis());
return e?a&&b:a},canPerformGeoAnalytics:function(){var a=!1,b=esri.isDefined(esriGeowConfig.self.helperServices.geoanalytics)&&esri.isDefined(esriGeowConfig.self.helperServices.geoanalytics.url);esri.isDefined(this.role.userActions)?a=!0===this.role.isAllowed("analysis_geoanalytics"):!arcgisonline.map.dijit.toc.analysis.role.isAnonymous()&&esri.isDefined(esriGeowConfig.userRole)&&(a=esriGeowConfig.userRole.canPublishFeatures()&&esriGeowConfig.userRole.canUseGeoanalytics());return a&&b},canPerformRasterAnalysis:function(a){a=
!1;var b=esri.isDefined(esriGeowConfig.self.helperServices.rasterAnalytics)&&esri.isDefined(esriGeowConfig.self.helperServices.rasterAnalytics.url);esri.isDefined(this.role.userActions)&&(a=!0===this.role.isAllowed("analysis_raster"));!arcgisonline.map.dijit.toc.analysis.role.isAnonymous()&&esri.isDefined(esriGeowConfig.userRole)&&(a=esriGeowConfig.userRole.canPublishFeatures()&&esriGeowConfig.userRole.canPublishImageCollection()&&esriGeowConfig.userRole.canUseRasterAnalysis());return a&&b&&(arcgisonline.sharing.util.isPortal()?
this.hasRasterAnalyticsServer:!0)},canPerformDynamicRasterAnalysis:function(a){return this.canPerformRasterAnalysis()&&esriGeowConfig.userRole.canPublishDynamicImagery()},canPerformTiledRasterAnalysis:function(a){return this.canPerformRasterAnalysis()&&esriGeowConfig.userRole.canPublishTiledImagery()},_canAnalyzeMS:function(a){return c.some(a,function(b){return!0===b._canAnalyze})},canPerformNetworkAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.asyncClosestFacility)&&
esri.isDefined(esriGeowConfig.self.helperServices.asyncServiceArea)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncVRP);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformPlanRoutesAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncVRP);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformODAnalysis:function(){var a=
esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncRoute);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformDriveAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncServiceArea);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_routing")&&
a},canPerformNearestAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncClosestFacility);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformLocAllocationAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncLocationAllocation);return this.canPerformSpatialAnalytics()&&
arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformGeoEnrichment:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.geoenrichment);return this.canPerformSpatialAnalytics()&&arcgisonline.map.role.isAllowed("analysis_geoenrichment")&&a},canPerformElevationAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.elevation);return this.canPerformSpatialAnalytics()&&a},canPerformElevationRasterAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.elevation);
return this.canPerformRasterAnalysis()&&a},canPerformHydroAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.hydrology);return this.canPerformSpatialAnalytics()&&a},canPerformHydroRasterAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.hydrology);return this.canPerformRasterAnalysis()&&a},checkOnAnalysisButton:function(){var a=this.canPerformAnalysis(),b=[],e,d=arcgisonline.map.main.mapLayers.slice(0),f=[],g=!0,l;esriGeowConfig.showAnalysisHistory&&
(l=c.aspect.after(this,"enableAnalysisButton",c.hitch(this,function(){l.remove();l=null;this._setSaveJobsHandlers()})));0<arcgisonline.map.main.mapTables.length&&(d=d.concat(arcgisonline.map.main.mapTables.slice(0)));this.util.isPortal()&&(g=this.canPerformSpatialAnalytics()||this.canPerformGeoAnalytics()||this.canPerformRasterAnalysis(),a&&g&&this.checkAnalysisLicense(),this._onSignOutHandle||(this._onSignOutHandle=c.subscribe("onSignOut",c.hitch(this,function(){this.removeCustomTools()}))));a&&
g?this.checkLayers().always(c.hitch(this,function(){var k=c.some(d,function(m){var n=!1;this.isMS(m)?esri.isDefined(m._canAnalyze)?n=!0===m._canAnalyze:f.push(m):n=this.isAnalysisLayer(m);return n},this);k?this.enableAnalysisButton():0<f.length&&!this._canAnalyzeMS()&&(c.forEach(f,function(m,n){arcgisonline.map.dijit.toc.analysis.isAnalysisLayer(m)&&b.push(arcgisonline.map.dijit.toc.analysis._getLayers(m))}),e=new c.promise.all(b),e.then(c.hitch(this,function(m){m&&0<m.length&&(k=c.some(m,function(n){return n.flayers&&
0<n.flayers.length}),c.forEach(m,function(n){n._canAnalyze=esri.isDefined(n.flayers)&&0<n.flayers.length}),this.canPerformAnalysis()&&g&&this.enableAnalysisButton())})));this.enableAnalysisButton()})):this.disableAnalysisButton()},enableAnalysisButton:function(){isEmbedded&&isEmbedded.hideAnalysis||arcgisonline.map.role.isUseOnlyMap||!t.byId("webmap-analysis")||"none"!==c.style(t.byId("webmap-analysis").domNode,"display")||(t.byId("webmap-analysis").set("disabled",!1),10>=c.isIE?c.style(t.byId("webmap-analysis").domNode,
"display","inline-block"):c.style(t.byId("webmap-analysis").domNode,"display",""),arcgisonline.map.main.checkMinWidthOfPage())},disableAnalysisButton:function(){t.byId("webmap-analysis")&&"none"!==c.style(t.byId("webmap-analysis").domNode,"display")&&(c.style(t.byId("webmap-analysis").domNode,"display","none"),arcgisonline.map.main.checkMinWidthOfPage())},getFederatedServers:function(){var a=new c.Deferred,b=arcgisonline.sharing.util.isPortal(),e=arcgisonline.sharing.util.getUser();b&&e&&!esriGeowConfig.federatedServers?
this.util.request({url:esriGeowConfig.restBaseUrl+"portals/"+esriGeowConfig.self.id+"/servers"}).then(c.hitch(this,function(d){this.util.setFederatedServers((d||{}).servers||[]);a.resolve(esriGeowConfig.federatedServers)}),c.hitch(this,function(d){esriGeowConfig.federatedServers=[];a.resolve([])})):a.resolve(esriGeowConfig.federatedServers);return a},getLicense:function(a){var b=new c.Deferred,e;0===a.length&&b.resolve(null);var d=c.filter(a,function(f){return"HOSTING_SERVER"===f.serverRole},this);
this.hasRasterAnalyticsServer=a&&a.some(function(f){return f.serverFunction&&-1<f.serverFunction.toLowerCase().indexOf("rasteranalytics")},this);0<d.length&&(e=d[0]);this.util.request({url:esriGeowConfig.restBaseUrl+"portals/"+esriGeowConfig.self.id+"/servers/"+e.id}).then(c.hitch(this,function(f){var g=c.mixin({},f);f=esri.isDefined(f.edition)||esri.isDefined(f.level)?null:"svradvanced";this.licenseLevel=g.edition?g.edition.name:f;b.resolve({licenseInfo:g,licenseLevel:this.licenseLevel})}));return b},
checkAnalysisLicense:function(){var a=new c.Deferred;if(this.licenseDef){if(this.licenseDef.isResolved())return this.isAdvanceLicense="svradvanced"===this.licenseLevel,a.resolve(this.isAdvanceLicense);this.licenseDef.then(c.hitch(this,function(){this.isAdvanceLicense="svradvanced"===this.licenseLevel;return a.resolve(this.isAdvanceLicense)}))}else this.licenseDef||(this.licenseDef=this.getFederatedServers().then(c.hitch(this,this.getLicense)),this.licenseDef.then(c.hitch(this,function(){this.isAdvanceLicense=
"svradvanced"===this.licenseLevel;return a.resolve(this.isAdvanceLicense)})));return a},showInfoDialog:function(a){esri.isDefined(a)&&arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:a.title||this.i18n.errorTitle,message:a.message||""})},clear:function(){arcgisonline.map.dijit.toc.analysis.mapLayer=null;arcgisonline.map.dijit.toc.analysis.menuSubLayerPos=null;arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder=null;arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder=
null;arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer=null},getFeatureLayers:function(a){var b=[],e=[];this.i18n||(this.i18n={},this.i18n=c.i18n.getLocalization("arcgisonline","arcgisonline").common,c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel),c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").analysisTool));c.forEach(a,function(d){var f=d.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer;d.layer instanceof esri.layers.ArcGISTiledMapServiceLayer||
f?(d.flayers=c.map(d.flayers,function(g){g.name&&-1===g.name.indexOf("-")&&(g.name=d.title+"-"+g.name);return g}),b=b.concat(d.flayers)):d.layers&&0<d.layers.length?(e=c.filter(d.layers,function(g){g.graphics&&0<g.graphics.length&&g.name&&-1===g.name.indexOf("(")&&(g.name=d.title+" ("+g.name+")");g.timeInfo&&d.serviceInfo&&d.serviceInfo.useStandardizedQueries&&(g._useStandardizedQueries=d.serviceInfo.useStandardizedQueries);return g.graphics&&0<g.graphics.length}),b=b.concat(e)):d.layer instanceof
esri.layers.GeoRSSLayer?(f=d.layer.getFeatureLayers(),f=c.filter(f,function(g){g.graphics&&0<g.graphics.length&&(!g.name||g.name&&-1===g.name.indexOf("("))&&(g.name=d.title+" ("+(g.name?g.name:"esriGeometryPoint"===g.geometryType?this.i18n.points:"esriGeometryPolygon"===g.geometryType?this.i18n.areas:this.i18n.lines)+")");-1!==d.layer.capabilities.toLowerCase().indexOf("extract")&&(g.capabilities=0<g.capabilities.length?g.capabilities+",Extract":"Extract");return g.graphics&&0<g.graphics.length},
this),b=b.concat(f)):(d.layer.name=d.title,d.layer&&d.layer.timeInfo&&d.serviceInfo&&d.serviceInfo.useStandardizedQueries&&(d.layer._useStandardizedQueries=d.serviceInfo.useStandardizedQueries),b.push(d.layer))},this);return b},configureAnalysisHistory:function(a,b){b.rerunItem=a&&a.rerunItem;b.openAnalysisHistoryPanel=esriGeowConfig.showAnalysisHistory&&!b.rerunItem;this.configureAnalysis(a,b)},initContextRerun:function(a,b){this._selectedAnalysisJobHandle&&(this._selectedAnalysisJobHandle.remove(),
this._selectedAnalysisJobHandle=c.topic.subscribe("analysis/jobs/selectedjob",c.hitch(this,this._openAnalysisToolFromJob,a)));this.jobsViewModel?!this.jobsViewModel.item||b&&this.jobsViewModel.item.id!==b.itemCard.id?this.jobsViewModel.set("item",b&&b.itemCard):b&&this.jobsViewModel.item.id===b.itemCard.id&&this.jobsViewModel.currentJob&&this._openAnalysisToolFromJob(a,this.jobsViewModel.currentJob,this.jobsViewModel.item):(this.jobsViewModel=new esri.dijit.analysis.JobsViewModel({portalUrl:esriGeowConfig.restBaseUrl.substring(0,
esriGeowConfig.restBaseUrl.indexOf("/sharing/rest")),item:b&&b.itemCard}),this.jobsViewModel.watch("jobs",c.hitch(this,this.openJobsWidget)),this._selectedAnalysisJobHandle||(this._selectedAnalysisJobHandle=c.topic.subscribe("analysis/jobs/selectedjob",c.hitch(this,this._openAnalysisToolFromJob,a))))},openJobsWidget:function(){this.jobsViewModel.jobs&&1===this.jobsViewModel.jobs.length&&this.jobsViewModel.set("currentJob",this.jobsViewModel.jobs[0])},_openAnalysisToolFromJob:function(a,b,e){if(b){e=
{};var d="";c.mixin(e,a);c.mixin(e,b.jobParams);e.toolName=b.toolName;e.rerun=!0;for(var f in e)e.hasOwnProperty(f)&&-1!==f.toLowerCase().indexOf("layer")&&e[f]&&!0===e[f].empty&&(d+=c.string.substitute(this.i18n.layerUnAvailable,{layerName:e[f].name})+"\x3cbr/\x3e",this.showErrorDlg(a),e[f]=null);""!==d&&this.showErrorDlg({message:d});b.jobInfo&&"geoanalytics"===b.jobInfo.analysisServer?e.analysisMode="bigdata":b.jobInfo&&"raster"===b.jobInfo.analysisServer?e.analysisMode="raster":arcgisonline.sharing.util.isPortal()&&
b.jobInfo&&"standard"===b.jobInfo.analysisServer&&(this.canPerformGeoAnalytics()||this.canPerformRasterAnalysis())&&(e.analysisMode="standard");arcgisonline.map.leftPanel.openAnalysisToolPanel(e)}},checkAnalysisPriv:function(){var a=arcgisonline.map.dijit.toc.analysis,b=a.canPerformAnalysis(),e=!0;a.util.isPortal()&&(e=a.canPerformSpatialAnalytics()||a.canPerformGeoAnalytics()||a.canPerformRasterAnalysis());return b&&e},configureCustomGP:function(a){a&&(a.taskUrl||a.itemCard)&&this.checkAnalysisPriv()&&
this.configureAnalysis(null,c.mixin(a,{toolName:"GPWidget",analysisMode:"standard"}))},initCustomGP:function(a){a&&(a.taskUrl||a.itemCard)&&(a.taskUrl?arcgisonline.map.leftPanel.openAnalysisToolPanel(a):a.itemCard&&esri.request({url:a.itemCard.url,content:{f:"json"}}).then(c.hitch(this,function(b){b=c.map(b.tasks,function(e){return{taskUrl:a.itemCard.url+"/"+e,title:e}});a.tool=c.mixin({},a.itemCard);a.tool.tasks=b;arcgisonline.map.leftPanel.openLeftAnalysisPanel(a)})))},isCustomGPTool:function(){return arcgisonline.map.dijit.toc.analysis.isCustomGP},
getCustomGPToolStack:function(){return"url"===arcgisonline.map.dijit.toc.analysis.customGPType?"toolStack":"analysisStack"},getCustomTools:function(){var a=[];if(window.sessionStorage){var b=window.sessionStorage.getItem("esri_analysis_customtools");b&&(a=c.json.parse(b))}return a},saveCustomTools:function(a){window.sessionStorage&&window.sessionStorage.setItem("esri_analysis_customtools",c.json.stringify(a))},removeCustomTools:function(){window.sessionStorage&&window.sessionStorage.getItem("esri_analysis_customtools")&&
window.sessionStorage.removeItem("esri_analysis_customtools")},showErrorDlg:function(a){var b="";var e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();a.message&&(b=a.message);e.show({title:this.i18n.errorTitle,message:b})}}});