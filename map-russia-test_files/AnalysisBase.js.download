//>>built
define("esri/dijit/analysis/AnalysisBase","require dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/json dojo/has dojo/json dojo/Deferred dojo/promise/all dojo/when dojo/data/ItemFileWriteStore dojo/string dojo/Evented dojo/_base/kernel dojo/Stateful ../../kernel ../../lang ../../request ../../tasks/Geoprocessor dojo/i18n!../../nls/jsapi ./utils ./storageUtils ./ItemTypes ../../IdentityManager".split(" "),function(A,y,e,t,h,J,K,u,E,L,M,B,G,H,I,p,k,q,C,z,v,F,x){y=y([I,G],{declaredClass:"esri.dijit.analysis.AnalysisBase",
isOutputLayerItemUpdated:!1,analysisGpServer:null,toolName:null,portalUrl:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,signInPromise:null,getResultLyrInfos:!1,checkCreditLimits:!1,useGPCreditTask:!0,_isGPCreditSync:!0,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,_analysisType:"feature",doRefreshItem:!0,doSaveJobInfo:!1,doSaveInStorage:!1,_doDeleteViewResult:!1,outputName:"OutputName",_freeGPTools:["CreateWatersheds","CreateViewshed","TraceDownstream"],constructor:function(a){this.isOutputLayerItemUpdated=
!1;this._rids=[];this._counter=0;this._popupInfo=[];a.analysisGpServer?this._signIn(a.analysisGpServer):a.portalUrl&&(this.portalUrl=a.portalUrl,this._signIn(a.portalUrl,!0));this.i18n={};e.mixin(this.i18n,z.common);e.mixin(this.i18n,z.analysisTools);e.mixin(this.i18n,z.analysisMsgCodes);e.mixin(this.i18n,z.analysisSettings);this.signInPromise.then(e.hitch(this,this._initErrorHelpMap))},execute:function(a){var d;this.jobParams=a.jobParams;this.jobParams.actualOutputName=this.outputName;var b=this.jobParams[this.outputName];
this._analysisType=a.analysisType||"feature";this._updateContext();var c=h.fromJson(this.jobParams.context);b&&(d=h.fromJson(b));!b||d&&!d.serviceProperties?(this.itemParams=null,this.jobParams.resultName=this.get("resultName")):this.showGeoAnalyticsParams&&b&&c&&c.dataStore&&-1===["BDS","GDB"].indexOf(c.dataStore)?(this.jobParams._gaxOutName=d.serviceProperties.name.replace(/[\s]|\-|\./g,"_"),this.jobParams[this.outputName]=null,this.jobParams.outputType=x.BDFSTEMPLATE,this.itemParams=null):(this.showGeoAnalyticsParams&&
"CopyToDataStore"===this.toolName&&c&&c.dataStore&&-1!==["BDS","GDB"].indexOf(c.dataStore)&&(delete c.dataStore,this.jobParams.context=h.toJson(c)),this.itemParams=a.itemParams);k.isDefined(a.isSpatioTemporalDataStore)&&(this._isSpatioTemporalDataStore=v.settingsVM&&v.settingsVM.datastore&&"CopyToDataStore"!==this.toolName?"BDS"===v.settingsVM.datastore:a.isSpatioTemporalDataStore);this.signInPromise.then(e.hitch(this,this._checkUser))},_updateContext:function(){var a;this.rerun&&this.context&&this._useExtentCheck&&
!this._useExtentCheck.get("checked")&&(this.context.extent=null);this.context&&((a=h.fromJson(this.jobParams.context))||(a={}),this.context.outSR&&!a.outSR&&(a.outSR=this.context.outSR),this.context.processSR&&!a.processSR&&(a.processSR=this.context.processSR),this.context.extent&&!a.extent&&(a.extent=this.context.extent),this.showGeoAnalyticsParams&&this.context.dataStore&&!a.dataStore&&(a.dataStore=this.context.dataStore),"raster"===this.analysisMode&&(this.context.cellSize&&!a.cellSize&&(a.cellSize=
this.context.cellSize),this.context.mask&&!a.mask&&(a.mask=this.context.mask),!this.context.snapRaster||a.snapRaster||this.isDetectObjectTool||(a.snapRaster=this.context.snapRaster),this.isDLTool||this.isOutputFeatureTool||this.isProximityTool||!this.context.resamplingMethod||a.resamplingMethod||(a.resamplingMethod=this.context.resamplingMethod)),this.isDLTool&&(this.context.processorType&&!a.processorType&&(a.processorType=this.context.processorType),"feature"===this._analysisType&&this.context.cellSize&&
!a.cellSize&&(a.cellSize=this.context.cellSize)),this.isPPFTool&&this.context.parallelProcessingFactor&&!a.parallelProcessingFactor&&(a.parallelProcessingFactor=this.context.parallelProcessingFactor),this.jobParams.context=h.toJson(a))},_checkUser:function(){var a;if(a=p.id.findCredential(this.portalUrl).userId)a=this.portalUrl+"/sharing/rest/community/users/"+a,q({url:a,content:{f:"json"}}).then(e.hitch(this,this._handleUserProfileResponse),e.hitch(this,function(d){this.emit("job-fail",{message:d.message+
(d.details?d.details.toString():""),jobParams:this.jobParams})}))},getUserProfile:function(){var a=new u;this.userProfile?a.resolve(this.userProfile):this.signInPromise.then(e.hitch(this,function(d){if(d=d.userId)d=this.portalUrl+"/sharing/rest/community/users/"+d,q({url:d,content:{f:"json"}}).then(e.hitch(this,function(b){this.userProfile=b;a.resolve(b)}),e.hitch(this,function(b){a.reject(b)}))}));return a.promise},_handleUserProfileResponse:function(a){var d=this.jobParams.outputType&&this.jobParams.outputType===
x.FLAYERVIEW;if(k.isDefined(a)&&k.isDefined(a.orgId))if(-1===t.indexOf(["account_admin","account_publisher","org_admin","org_publisher"],a.role))this.emit("job-fail",{message:this.i18n.pubRoleMsg,messageCode:"AB_0001",jobParams:this.jobParams});else if(k.isDefined(a.availableCredits)&&this.get("checkCreditLimits")&&!d&&!this._byPassCreditCheck(this.toolName)){var b,c={},f=this.toolName,g=new u;var l=this._cleanUpJobParamsForSubmit();for(b in l)l.hasOwnProperty(b)&&("object"===typeof l[b]?c[b]=h.toJson(l[b]):
-1!==t.indexOf(["measurementtype"],b.toLowerCase())&&"StraightLine"!==l[b]?(d=h.fromJson(l[b]),c[b]=d?d.name.replace(/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?]/g,""):"DrivingTime"):c[b]=l[b]);this.isRaster&&(f=this.rasterGPToolName,c.functionArguments&&(c.functionArguments=h.fromJson(c.functionArguments)),c.context&&(c.context=h.fromJson(c.context)));k.isDefined(this.itemParams)&&!this.isRaster?g=this._checkServiceName(a.orgId,!0):g.resolve(!0);g.then(e.hitch(this,function(m){m&&(this.isRaster&&k.isDefined(this.estimatedCost)?
a.availableCredits>this.estimatedCost?this._runJob():this.emit("job-fail",{message:this.i18n.insufficientCreditsMsg,messageCode:"AB_0001",jobParams:this.jobParams}):this.getCreditsEstimate(f,c,this.isRaster).always(e.hitch(this,function(n){var r=n&&k.isDefined(n.cost)?n.cost:n.maximumCost;k.isDefined(r)&&a.availableCredits>r?this._runJob():n&&(n.messageCode||n.message)&&0!==n.status?(r=k.isDefined(this.i18n[n.messageCode])?this.i18n[n.messageCode]:n.message,r=k.isDefined(n.params)?B.substitute(r,
n.params):r,this.emit("job-fail",{message:r,messageCode:"AB_0001",jobParams:this.jobParams})):this.isRaster&&k.isDefined(r)&&a.availableCredits<r?this.emit("job-fail",{message:this.i18n.insufficientCreditsMsg,messageCode:"AB_0001",jobParams:this.jobParams}):this._runJob()})))}))}else k.isDefined(this.itemParams)?this._checkServiceName(a.orgId):(this.emit("start",this.jobParams),this._submitGpJob());else this.emit("job-fail",{message:this.i18n.orgUsrMsg,jobParams:this.jobParams})},_runJob:function(){k.isDefined(this.itemParams)?
("raster"===this._analysisType?this._createImageService():this._createService(),this.emit("start",this.jobParams)):(this.emit("start",this.jobParams),this._submitGpJob())},_checkServiceName:function(a,d){var b=new u;p.id.findCredential(this.portalUrl);a=this.portalUrl+"/sharing/rest/portals/"+a+"/isServiceNameAvailable";var c=h.fromJson(this.jobParams[this.outputName]);k.isDefined(c.serviceProperties)&&k.isDefined(c.serviceProperties.name)&&(c.serviceProperties.name=c.serviceProperties.name.replace(/[\s]|\-|\./g,
"_"),this.jobParams[this.outputName]=h.toJson(c));q({url:a,content:{name:c.serviceProperties.name,type:"raster"===this._analysisType?"Image Service":"Feature Service",f:"json"}}).then(e.hitch(this,function(f){f.available?(d||("raster"===this._analysisType?this._createImageService():this._createService(),this.emit("start",this.jobParams)),b.resolve(!0)):(this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams}),b.resolve(!1))}),e.hitch(this,
function(f){this.emit("job-fail",{message:f.message+(f.details?f.details.toString():""),jobParams:this.jobParams});b.resolve(!1)}));return b},_checkServiceNameOnly:function(a,d){var b=new u;p.id.findCredential(this.portalUrl);q({url:this.portalUrl+"/sharing/rest/portals/"+a+"/isServiceNameAvailable",content:{name:d,type:"Image Service",f:"json"}}).then(e.hitch(this,function(c){c.available?b.resolve(!0):(this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams}),
b.resolve(!1))}),e.hitch(this,function(c){this.emit("job-fail",{message:c.message+(c.details?c.details.toString():""),jobParams:this.jobParams});b.resolve(!1)}));return b},_createService:function(){var a=this._submitGpJob;var d=p.id.findCredential(this.portalUrl).userId;var b=h.fromJson(this.jobParams[this.outputName]);if(d){var c=this.itemParams.folder;d=this.portalUrl+"/sharing/rest/content/users/"+d+(c&&"/"!==c?"/"+c:"")+"/createService";b={createParameters:h.toJson({currentVersion:10.2,serviceDescription:"",
hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!0,maxRecordCount:2E3,supportedQueryFormats:"JSON",capabilities:"Query",description:"",copyrightText:"",allowGeometryUpdates:!1,syncEnabled:!1,editorTrackingInfo:{enableEditorTracking:!1,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},tables:[],name:b.serviceProperties.name}),outputType:"featureService",
f:"json"};this._isSpatioTemporalDataStore&&(c=h.fromJson(b.createParameters),c.options={dataSourceType:"spatiotemporal"},b.createParameters=h.toJson(c));this.jobParams.outputType&&this.jobParams.outputType===x.FLAYERVIEW&&(c=h.fromJson(b.createParameters),e.mixin(b,this._getViewCreateParams()),b.createParameters=h.toJson(c),a=this._addViewDefinition);q({url:d,content:b},{usePost:!0}).then(e.hitch(this,a),e.hitch(this,this._handleCreateServiceError))}},_createImageService:function(){var a=p.id.findCredential(this.portalUrl).userId;
var d=h.fromJson(this.jobParams[this.outputName]);if(a){var b=this.itemParams.folder;a=this.portalUrl+"/sharing/rest/content/users/"+a+(b&&"/"!==b?"/"+b:"")+"/createService";d={createParameters:h.toJson({name:d.serviceProperties.name,description:"",capabilities:d.serviceProperties.capabilities||"Image",properties:{isCached:!0,path:"@",description:"",copyright:""}}),outputType:"imageService",f:"json"};q({url:a,content:d},{usePost:!0}).then(e.hitch(this,this._submitGpJob),e.hitch(this,this._handleCreateServiceError))}},
_handleCreateServiceError:function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_getViewCreateParams:function(){return{isView:!0}},_addViewDefinition:function(a){var d;if(this.itemParams){this.currentGpItemId=a.itemId;var b=h.fromJson(this.jobParams[this.outputName]);b.serviceProperties&&(b.serviceProperties.serviceUrl=a.serviceurl);b.itemProperties={itemId:a.itemId};this.itemParams.folder&&(b.itemProperties.folderId=this.itemParams.folder);
this.jobParams[this.outputName]=h.toJson(b)}this.getViewParams({jobParams:this.jobParams,resultService:{url:a.serviceurl,itemId:a.itemId}}).then(e.hitch(this,function(c){d=c;var f={jobId:"ViewJob_"+(new Date).getTime(),jobStatus:"esriJobSubmitted",jobParams:this.jobParams};this._addToDefinition(a.serviceurl,d).then(e.hitch(this,function(g){var l={value:{}};this._doDeleteViewResult||(this._jobInfo.jobStatus="esriJobSucceeded",setTimeout(e.hitch(this,function(){this.itemParams.properties={jobUrl:g.serviceurl+
"/jobs/"+this._jobInfo.jobId,jobType:"GPServer",jobId:this._jobInfo.jobId,jobStatus:"completed"};this._readItem()}),300),this.doSaveJobInfo&&this.saveJobInfo(this._jobInfo),l.outputLayerName=h.fromJson(this.jobParams[this.outputName]).serviceProperties.name,l.value.itemId=this.currentGpItemId,l.analysisInfo={toolName:this.toolName,secondaryOutputs:this.secondaryOutputs,jobParams:this.jobParams},this.emit("job-result",l))}),e.hitch(this,this._gpJobFailed));this.emit("job-submit",this.jobParams);setTimeout(e.hitch(this,
function(){this._jobInfo=f;this._jobInfo.jobStatus="esriJobExecuting";this._readItem();this.emit("job-status",this._jobInfo)},0))}),e.hitch(this,this._gpJobFailed))},_addToDefinition:function(a,d){a=a.replace("/rest/services","/rest/admin/services")+"/addToDefinition";var b=p.id.findCredential(this.portalUrl);d={f:"json",addToDefinition:h.toJson(d),token:b.token};return q({url:a,content:d},{usePost:!0})},_getAdminLayerInfo:function(a){a=a.replace("/rest/services","/rest/admin/services");var d={f:"json",
token:p.id.findCredential(this.portalUrl).token};return q({url:a,content:d})},_getSelf:function(a){return q({url:a+"/sharing/rest/portals/self",content:{culture:H.locale,f:"json"},callbackParamName:"callback",timeout:0},{})},_submitGpJob:function(a){var d=h.fromJson(this.jobParams.context);this._doCancelCleanup=!1;if(this.itemParams){this.currentGpItemId=a.itemId;var b=h.fromJson(this.jobParams[this.outputName]);b.serviceProperties&&(b.serviceProperties.serviceUrl=a.serviceurl);b.itemProperties={itemId:a.itemId};
this.itemParams.folder&&(b.itemProperties.folderId=this.itemParams.folder);this.jobParams[this.outputName]=h.toJson(b)}if(this.analysisGpServer){this._toolServiceUrl&&this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);this.gp.setUpdateDelay(3E3);if(this.showGeoAnalyticsParams&&this.jobParams._gaxOutName&&d.dataStore&&-1===["BDS","GDB"].indexOf(d.dataStore)){var c=this.jobParams[this.outputName]=this.jobParams._gaxOutName;delete this.jobParams._gaxOutName}this.itemParams||
delete this.jobParams.resultName;this.gp.submitJob(this._cleanUpJobParamsForSubmit(),e.hitch(this,this._gpJobComplete),e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed));this.itemParams||(this.jobParams.resultName=this.get("resultName"));c&&(this.jobParams[this.outputName]=null);this.emit("job-submit",this.jobParams)}else this._getSelf(this.portalUrl).then(e.hitch(this,function(f){this.analysisGpServer=f.helperServices.analysis&&f.helperServices.analysis.url?f.helperServices.analysis.url:
null;this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);this.gp.setUpdateDelay(3E3);this.itemParams||delete this.jobParams.resultName;this.gp.submitJob(this.jobParams,e.hitch(this,this._gpJobComplete),e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed));this.itemParams||(this.jobParams.resultName=this.get("resultName"));this.emit("job-submit",this.jobParams)}))},_cleanUpJobParamsForSubmit:function(){var a=e.mixin({},this.jobParams),d=["actualOutputName","aLayer","attributeExprObj",
"data","resultName"].concat(this.removeJobParamKeys||[]),b;for(b in a)a.hasOwnProperty(b)&&-1!==d.indexOf(b)&&delete a[b];return a},_updateItem:function(a){var d;if(d=p.id.findCredential(this.portalUrl).userId){var b=this.itemParams.folder;d=this.portalUrl+"/sharing/rest/content/users/"+d+(b&&"/"!==b?"/"+b:"")+"/items/"+this.currentGpItemId+"/update";if(a)var c=a.item.properties;k.isDefined(c)||(c={});k.isDefined(c.jobUrl)||(c.jobUrl=this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId,c.jobType="GPServer",
c.jobId=this._jobInfo.jobId,c.jobStatus="processing",this.itemParams.properties=c);c=e.mixin({f:"json"},this.itemParams);a&&c.folder===a.item.folder&&delete c.folder;a&&a.item&&c.tags===a.item.tags.toString()&&delete c.tags;a&&a.item&&c.snippet===a.item.snippet&&delete c.snippet;a&&a.item&&c.description===a.item.description&&delete c.description;c.properties&&(c.properties=h.toJson(c.properties));c.text&&(c.text=h.toJson(c.text));a=q({url:d,content:c},{usePost:!0});a.then(e.hitch(this,this._handleItemUpdate),
e.hitch(this,this._handleUpdateItemError));return a}},_handleItemUpdate:function(a){this.isOutputLayerItemUpdated=!0},_handleItemDataUpdate:function(a){},_handleUpdateItemError:function(a){this.isOutputLayerItemUpdated=!0;this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_handleErrorResponse:function(a){this.emit("job-fail",a)},_refreshItem:function(){var a;if(a=p.id.findCredential(this.portalUrl).userId){var d=this.itemParams.folder;a=this.portalUrl+
"/sharing/rest/content/users/"+a+(d&&"/"!==d?"/"+d:"")+"/items/"+this.currentGpItemId+"/refresh";a=q({url:a,content:{f:"json"}},{usePost:!0})}else a=new u,a.resolve();return a.promise},_handleItemRefresh:function(a){},_readItem:function(){var a;if(a=p.id.findCredential(this.portalUrl).userId){var d=this.itemParams.folder;a=this.portalUrl+"/sharing/rest/content/users/"+a+(d&&"/"!==d?"/"+d:"")+"/items/"+this.currentGpItemId;a=q({url:a,content:{f:"json"}});return a.then(e.hitch(this,this._updateItem))}},
getItemInfo:function(a){if(p.id.findCredential(this.portalUrl).userId)return a=this.portalUrl+"/sharing/rest/content/items/"+a,q({url:a,content:{f:"json"}})},_gpJobStatus:function(a){a.jobParams=this.jobParams;a.resultParameter=this.resultParameter;a.returnProcessInfo=this.jobParams.returnProcessInfo;a.getResultLyrInfos=this.getResultLyrInfos;a.currentGpItemId=this.currentGpItemId;a.itemParams=this.itemParams;"esriJobFailed"===a.jobStatus||"esriJobSucceeded"===a.jobStatus||"esriJobTimedOut"===a.jobStatus?
(a.messages&&(a.message=this._buildErrorMsg(a)),this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null,this._gpJobComplete(a)),"esriJobFailed"!==a.jobStatus&&"esriJobTimedOut"!==a.jobStatus||this._deleteItem(!1)):-1===["esriJobCancelling","esriJobCancelled"].indexOf(a.jobStatus)||this._doCancelCleanup||(this._handleOnCancel(a),this._doCancelCleanup=!0);this.doSaveJobInfo&&this.saveJobInfo(a);this.emit("job-status",a);this._jobInfo=a;this.itemParams&&!this.isOutputLayerItemUpdated&&
this._readItem()},_updateRefreshItem:function(a){var d=[],b=a[0];d.push(this._readItem(this.doRefreshItem));E(d).then(e.hitch(this,function(c){b.outputLayerName=h.fromJson(this.jobParams[this.outputName]).serviceProperties.name;b.value.itemId=this.currentGpItemId;b.analysisInfo={toolName:this.toolName,secondaryOutputs:this.secondaryOutputs,jobParams:this.jobParams};this.doRefreshItem?this._refreshItem().always(e.hitch(this,function(){this.emit("job-result",b)})):this.emit("job-result",b)}),e.hitch(this,
this._handleDeleteItemError))},_gpJobComplete:function(a){var d;"esriJobSucceeded"===a.jobStatus&&(a.jobParams=this.jobParams,this.emit("job-success",a),E(this._getGpResultData(a)).then(e.hitch(this,function(b){b=t.filter(b,function(c){var f=!0;k.isDefined(c.value.empty)?f=c.value.empty:k.isDefined(c.value.url)||k.isDefined(c.value.itemId)?f=!1:k.isDefined(c.value.featureSet)?f=!1:this.jobParams.outputType===x.BDFSTEMPLATE&&(f=!1);if(!f)return c},this);0===b.length?(this.currentGpItemId&&this._deleteItem(!1),
this.showGeoAnalyticsParams&&a.messages&&(a.message=this._buildErrorMsg(a)),this.emit("job-fail",{message:this.showGeoAnalyticsParams?a.message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams})):(k.isDefined(this.itemParams)&&this.itemParams.properties&&this.itemParams.properties.jobStatus&&"processing"===this.itemParams.properties.jobStatus&&(this.itemParams.properties.jobStatus="completed"),t.forEach(b,function(c){if(c.value.featureSet&&!c.value.url)c.value.featureSet.spatialReference=
c.value.layerDefinition.spatialReference;else if(c.value.url&&-1!==c.value.url.indexOf("/FeatureServer/")&&c.value.layerInfo&&c.value.layerInfo.popupInfo){var f=c.value.url.match(/[0-9]+$/g)[0];this._popupInfo[f]=c.value.layerInfo.popupInfo}},this),d=b[0],d.results=b,this.jobParams.returnProcessInfo?this.gp.getResultData(a.jobId,"processInfo").then(e.hitch(this,function(c){var f=[];t.forEach(c.value,function(g){f.push(h.fromJson(g))},this);this.currentGpItemId?(this.itemParams.description=v.buildReport(f),
this._updateRefreshItem(b)):(d.analysisReport=v.buildReport(f),d.outputLayerName=this.jobParams.resultName,this.emit("job-result",d))})):this.currentGpItemId?this._updateRefreshItem(b):(d.outputLayerName=this.jobParams.resultName,this.emit("job-result",d)))})))},_gpJobFailed:function(a){var d=e.clone(a);d.jobParams=this.jobParams;this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null);a.messages&&(a.message=this._buildErrorMsg(a));this.emit("job-fail",d)},_getGpResultData:function(a){var d=
[],b=[];"string"===typeof this.resultParameter?b.push(this.resultParameter):this.resultParameter instanceof Array&&(b=this.resultParameter,this.secondaryOutputs&&this.secondaryOutputNames&&(b=t.filter(b,function(c){c=this.secondaryOutputs.indexOf(c);return-1===c?!0:a.jobParams.hasOwnProperty(this.secondaryOutputNames[c])},this)));t.forEach(b,function(c,f){d.push(this.gp.getResultData(a.jobId,c))},this);return d},_handleOnCancel:function(a){this.itemParams?this._deleteItem(!0,a):this.emit("job-cancel",
a)},cancel:function(a){this.jobParams.outputType&&this.jobParams.outputType===x.FLAYERVIEW?(this._doDeleteViewResult=!0,this._deleteItem(!0)):this.gp.cancelJob(a.jobId).then(e.hitch(this,function(d){"esriJobCancelled"===d.jobStatus&&this._handleOnCancel(d)}),function(d){})},checkJobStatus:function(a){this.signInPromise.then(e.hitch(this,function(){this.gp.setUpdateDelay(3E3);this._checkTimer=setInterval(e.hitch(this,this._checkStatus,a,e.hitch(this,this._gpJobStatus),e.hitch(this,this._gpJobFailed)),
3E3)}))},_checkStatus:function(a,d,b){this.gp.checkJobStatus(a,d,b)},_deleteItem:function(a,d){var b;if((b=p.id.findCredential(this.portalUrl).userId)&&this.itemParams){var c=k.isDefined(this.itemParams.folder)?this.itemParams.folder:"";b=this.portalUrl+"/sharing/rest/content/users/"+b+(c&&"/"!==c?"/"+c:"")+"/items/"+this.currentGpItemId+"/delete";q({url:b,content:{f:"json"}},{usePost:!0}).then(e.hitch(this,this._handleItemDelete,a,d),e.hitch(this,this._handleDeleteItemError))}},_handleItemDelete:function(a,
d,b){a&&this.emit("job-cancel",d)},_handleDeleteItemError:function(a){this.emit("job-fail",{message:a.message+(a.details?a.details.toString():""),jobParams:this.jobParams})},_initFolderStore:function(a,d){this._fportal=this.portalSelf?new a.Portal({url:this.portalUrl,self:this.portalSelf}):new a.Portal(this.portalUrl);this._fportal.signIn().then(e.hitch(this,function(b){this.portalUser=b;this.portalUser.getFolders().then(e.hitch(this,function(c){c=v.createFolderStore(c,this.portalUser.username);d.resolve(c)}))}))},
getFolderStore:function(){var a=new u,d,b,c,f;this.folderStore?a.resolve(this.folderStore):this.signInPromise.then(e.hitch(this,function(g){d=["../../arcgis/Portal"];b=this._counter++;c=this;this._rids&&this._rids.push(b);A(d,function(l){f=c._rids?t.indexOf(c._rids,b):-1;-1!==f&&(c._rids.splice(f,1),c._initFolderStore(l,a))})}));return a},_checkToolUrl:function(){var a=new u;this.analysisGpServer?(this._toolServiceUrl&&this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),a.resolve({success:!0})):
this._getSelf(this.portalUrl).then(e.hitch(this,function(d){(this.analysisGpServer=d.helperServices.analysis&&d.helperServices.analysis.url?d.helperServices.analysis.url:null)&&this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName);a.resolve({success:!0})}));return a},getCreditsEstimate:function(a,d,b){this.start=window.performance.now();var c,f,g,l,m,n={};var r=new u;this._checkToolUrl().then(e.hitch(this,function(w){this._toolServiceUrl?l=this._toolServiceUrl:(g=this.portalUrl&&-1!==
this.portalUrl.indexOf("dev")?"dev":this.portalUrl&&-1!==this.portalUrl.indexOf("qa")?"qa":"",l="http://analysis"+g+".arcgis.com/arcgis/rest/services/tasks/GPServer/"+this.toolName);this.useGPCreditTask?(m=this.portalSelf||this._portal,b?(c=m&&m.helperServices&&m.helperServices.rasterAnalytics.url?m.helperServices.rasterAnalytics.url+"/EstimateRasterAnalysisCost":l.replace("/tasks/GPServer/"+a,"/RasterAnalysisTools/GPServer/EstimateRasterAnalysisCost"),n.name=a,n.parameters=d,w=d.context,w.cellSize=
this.context.cellSize,!w.extent&&this.context.extent&&(w.extent=this.context.extent),w={jobParams:{inputAnalysisTask:h.toJson(n),context:h.toJson(w)},resultParameter:"outCost",def:r,isGPCreditSync:!1}):(c=m&&m.helperServices&&m.helperServices.creditEstimation&&m.helperServices.creditEstimation.url?m.helperServices.creditEstimation.url+"/EstimateCredits":l.replace("/tasks/GPServer/"+a,"/Estimate/GPServer/EstimateCredits"),w={jobParams:{taskName:a,taskParameters:h.toJson(d)},resultParameter:"creditEstimate",
def:r,isGPCreditSync:this._isGPCreditSync}),this._getGPCreditEstimate(c,w)):(c=l.replace("/"+a,"/exts/Estimate/"+a),f=e.mixin({f:"json"},d),q({url:c,content:f},{usePost:!0}).then(e.hitch(this,function(D){this.end=window.performance.now();r.resolve(D)}),function(D){r.resolve(D)}))}));return r.promise},_getGPCreditEstimate:function(a,d){this.creditGP=new C(a);this.creditGP.setUpdateDelay(1E3);d.isGPCreditSync?this.creditGP.execute(d.jobParams,e.hitch(this,this._getGPCreditResult,d.def,d.resultParameter,
d.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,d.def,d.isGPCreditSync)):this.creditGP.submitJob(d.jobParams,e.hitch(this,this._getGPCreditResult,d.def,d.resultParameter,d.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,d.def,d.isGPCreditSync),e.hitch(this,this._creditGPJobFailed,d.def,d.isGPCreditSync))},_getGPCreditResult:function(a,d,b,c){b?(this.end=window.performance.now(),a.resolve(c[0].value)):this.creditGP.getResultData(c.jobId,d).then(e.hitch(this,function(f,g){g&&g.value&&0<=
g.value.credits&&(g.value.cost=g.value.credits);this.end=window.performance.now();f.resolve(g.value)},a),e.hitch(this,function(f,g){f.resolve(g)},a))},_creditGPJobFailed:function(a,d,b){d?!b.code||400!==b.code&&-1===b.code.indexOf("IdentityManagerBase.")?0===b.status&&b.message&&(b.messages=[b.message],a.resolve(this._buildErrorMsg(b))):(b.messages=b.details,a.resolve(b)):"esriJobFailed"!==b.jobStatus&&"esriJobCancelled"!==b.jobStatus||a.resolve(this._buildErrorMsg(b))},_signIn:function(a,d){var b,
c;this.signInPromise=new u;if(d){d=["../../arcgis/Portal"];var f=this._counter++;var g=this;this._rids&&this._rids.push(f);A(d,e.hitch(this,function(l){b=g._rids?t.indexOf(g._rids,f):-1;-1!==b&&(g._rids.splice(b,1),this._portal=this.portalSelf?new l.Portal({url:a,self:this.portalSelf}):new l.Portal(a),this._portal.signIn().then(e.hitch(this,function(m){this.portalUser=m;this._portal.helperServices&&this._portal.helperServices.analysis&&this._portal.helperServices.analysis.url?(this.analysisGpServer=
this._portal.helperServices.analysis.url,this.showGeoAnalyticsParams&&this._portal.helperServices.geoanalytics&&(this.analysisGpServer=this._portal.helperServices.geoanalytics.url),q({url:this.analysisGpServer,content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(n){c=p.id.findCredential(this.analysisGpServer);this.signInPromise.resolve(c)}),e.hitch(this,function(n){this.signInPromise.reject(n)}))):this.signInPromise.resolve(m)}),e.hitch(this,this._handleSignInError)))}))}else q({url:a,
content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(l){l=p.id.findCredential(a);if(k.isDefined(l)){var m=p.id.findServerInfo(this._toolServiceUrl);k.isDefined(m)&&k.isDefined(m.owningSystemUrl)&&(this.portalUrl=m.owningSystemUrl);this.signInPromise.resolve(l)}else p.id.getCredential(a).then(e.hitch(this,function(n){n=p.id.findCredential(a);m=p.id.findServerInfo(this._toolServiceUrl);k.isDefined(m)&&k.isDefined(m.owningSystemUrl)&&(this.portalUrl=m.owningSystemUrl);this.signInPromise.resolve(n)}),
e.hitch(this,this._handleSignInError))}),e.hitch(this,this._handleSignInError));return this.signInPromise},_handleSignInError:function(a){this.emit("job-fail",{message:this.i18n.analysisSignInErrorMsg,messageCode:"AB_0003"});this.signInPromise.reject(a)},_buildErrorMsg:function(a){var d="",b=[],c,f;this.errorHelpMap||this._initErrorHelpMap();b=t.filter(a.messages,function(g){if(("esriJobMessageTypeError"===g.type||"esriJobMessageTypeWarning"===g.type)&&-1!==g.description.indexOf("messageCode"))return g.description},
this);0<b.length&&t.forEach(b,function(g){try{c=h.fromJson(g.description)}catch(l){c=g.description}f="";"esriJobMessageTypeWarning"===g.type&&(a.type="warning");c.messageCode?(f=k.isDefined(this.i18n[c.messageCode])?this.i18n[c.messageCode]:c.message,f=k.isDefined(c.params)?B.substitute(f,c.params):f,d+=f+"\x26nbsp;",(g=this._addLearnMoreErrorLink(c.messageCode))&&(d+=g)):c.error&&c.error.messageCode?(f=k.isDefined(this.i18n[c.error.messageCode])?this.i18n[c.error.messageCode]:c.error.message,f=k.isDefined(c.error.params)?
B.substitute(f,c.error.params):f,d+=f+"\x26nbsp;",(g=this._addLearnMoreErrorLink(c.error.messageCode))&&(d+=g)):d+=c+"\x26nbsp;"},this);return d},_toolServiceUrlSetter:function(a){this._toolServiceUrl=a;this.gp=new C(a)},_setToolServiceUrlAttr:function(a){this._toolServiceUrl=a;this.gp=new C(a)},checkCreditLimitsAttr:function(a){this.checkCreditLimits=a},saveJobInfo:function(a){if(this.doSaveJobInfo&&this.currentGpItemId&&-1!==t.indexOf(["esriJobSucceeded"],a.jobStatus)){e.mixin(a.jobParams,{extentCheck:this._useExtentCheck&&
this._useExtentCheck.get("checked")});t.forEach(a.messages,function(c){c.description=v.safetagsReplace(c.description)},this);a={toolName:this.toolName,jobParams:a.jobParams,timestamp:Date.now(),portalUrl:this.portalUrl,jobInfo:{jobId:a.jobId,jobStatus:a.jobStatus,messages:a.messages,analysisServer:"bigdata"===this.analysisMode?"geoanalytics":"default"===this.analysisMode?"standard":this.analysisMode}};"CopyToDataStore"===this.toolName&&(a.jobParams.isSpatioTemporalDataStore=this._isSpatioTemporalDataStore);
"bigdata"===this.analysisMode&&a.jobParams.timeStepReference&&(a.jobParams.timeReferenceType=this.get("timeReferenceType"));"bigdata"===this.analysisMode&&a.jobParams.timeBoundaryReference&&(a.jobParams.timeBoundaryReferenceType=this.get("timeBoundaryReferenceType"));for(b in a.jobParams)if(a.jobParams.hasOwnProperty(b)&&k.isDefined(a.jobParams[b])){if("object"===typeof a.jobParams[b]&&a.jobParams[b].serviceToken||"string"===typeof a.jobParams[b]&&-1!==a.jobParams[b].indexOf("serviceToken")){var d=
"string"===typeof a.jobParams[b]?h.fromJson(a.jobParams[b]):a.jobParams[b];d&&d.serviceToken&&(delete d.serviceToken,a.jobParams[b]="string"===typeof a.jobParams[b]?h.toJson(d):d)}if("object"===typeof a.jobParams[b]&&!e.isArray(a.jobParams[b])&&a.jobParams[b].filter||"string"===typeof a.jobParams[b]&&-1!==a.jobParams[b].search(/[<>]/g))"object"===typeof a.jobParams[b]&&a.jobParams[b].filter&&!e.isArray(a.jobParams[b])?a.jobParams[b].filter=v.safetagsReplace(a.jobParams[b].filter):"string"===typeof a.jobParams[b]&&
-1!==a.jobParams[b].search(/[<>]/g)&&(a.jobParams[b]=v.safetagsReplace(a.jobParams[b]))}var b=p.id.findCredential(this.portalUrl);this.currentGpItemId&&(b={id:this.currentGpItemId,folderId:this.itemParams.folder,owner:b.userId},F.addToItemResource(b,a));this.doSaveInStorage&&F.addToStorage(a)}},_initErrorHelpMap:function(){if(this.isSingleTenant){var a=A.toUrl("./help/errorhelpmap_enterprise.json");q({url:a}).then(e.hitch(this,function(d){this.errorHelpMap=d.map}))}},_addLearnMoreErrorLink:function(a){if(this.isSingleTenant){var d=
this.portalSelf&&this.portalSelf.helpMap&&this.portalSelf.helpMap.m;a=d&&d[this.errorHelpMap[a]];d=this&&this.portalSelf?this.portalSelf.helpBase:null;var b=this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("dev")?"dev":this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("qa")?"uat":"";if(k.isDefined(a)){var c="http://doc"+b+".arcgis.com/en/arcgis-online/analyze/"+a;this.isSingleTenant&&d?c=d+a:this.isSingleTenant&&!d&&(c="http://server"+b+".arcgis.com/en/portal/latest/use/"+a)}c&&(c=
"\x3cbr/\x3e\x3cbr/\x3e\x3cdiv class\x3d'esriHelpPopup'\x3e\x3ca class\x3d'action zoomTo' href\x3d'"+c+"' target\x3d'_help'\x3e"+this.i18n.learnMore+"\x3c/a\x3e\x3c/div\x3e\x3cbr/\x3e\x3cbr/\x3e");return c}},getLearnMoreLink:function(a){return a?this._addLearnMoreErrorLink(a):""},_byPassCreditCheck:function(a){return-1!==this._freeGPTools.indexOf(a)}});e.setObject("dijit.analysis.AnalysisBase",y,p);return y});