//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore ../kernel ../config ../request ../SpatialReference ../geometry/jsonUtils ../geometry/webMercatorUtils".split(" "),function(q,g,F,T,U,V,W,G,X,C,H,I){function J(a){var c=0,e="";g.forEach([","," ",";","|","\t"],function(h){var k=a.split(h).length;k>c&&(c=k,e=h)});return e}function K(a,c){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return!1;a=!0;
if(T("chrome")&&/\d+\W*$/.test(c)){if(c.match(/[^0-9a-zA-Z\s]/))return!1;if(c=c.match(/[a-zA-Z]{2,}/)){a=!1;for(var e=0,h=c.length,k=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!a&&e<=h&&!(a=!k.test(c[e]));)e++;a=!a}}return a}function L(a,c,e){var h=a.indexOf("\n");h=q.trim(a.substr(0,h));var k=c.columnDelimiter;k||(k=J(h));var l=new V({data:a,separator:k});l.fetch({onComplete:function(r,
m){m=0;var b={layerDefinition:c.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},n=b.layerDefinition.objectIdField,d=b.layerDefinition.fields;n||g.some(d,function(f){return"esriFieldTypeOID"===f.type?(n=f.name,!0):!1})||(d.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),n="__OBJECTID");var v=l._attributes,M=[],y=[];g.forEach(d,function(f){"esriFieldTypeDate"===f.type?M.push(f.name):("esriFieldTypeDouble"===f.type||"esriFieldTypeInteger"===
f.type)&&y.push(f.name)});if(c.locationInfo&&"coordinates"===c.locationInfo.locationType){var t=c.locationInfo.latitudeFieldName;var u=c.locationInfo.longitudeFieldName}else g.forEach(v,function(f){var p=g.indexOf(N,f.toLowerCase());-1!==p&&(t=f);p=g.indexOf(O,f.toLowerCase());-1!==p&&(u=f)}),t&&u&&(c.locationInfo={locationType:"coordinates",latitudeFieldName:t,longitudeFieldName:u});if(t&&u){-1===g.indexOf(y,t)&&y.push(t);-1===g.indexOf(y,u)&&y.push(u);if(q.isArray(c.outFields)&&-1===g.indexOf(c.outFields,
"*"))var z=c.outFields;g.forEach(v,function(f){g.some(d,function(p){return f===p.name})||d.push({name:f,alias:f,type:f===t||f===u?"esriFieldTypeDouble":"esriFieldTypeString"})});v=0;var Y=r.length;for(v;v<Y;v++){var A=r[v],B=l.getAttributes(A),w={};g.forEach(B,function(f){if(f&&(f===t||f===u||!z||-1<g.indexOf(z,f))){var p=f;0===f.length&&g.forEach(d,function(Z,P){Z.name==="attribute_"+(P-1)&&(f="attribute_"+(P-1))});if(-1<g.indexOf(M,f)){p=l.getValue(A,p);var x=new Date(p);w[f]=K(x,p)?x.getTime():
null}else-1<g.indexOf(y,f)?(x=U.parse(l.getValue(A,p)),f!==t&&f!==u||!(isNaN(x)||181<Math.abs(x))||(x=parseFloat(l.getValue(A,p))),isNaN(x)?w[f]=null:w[f]=x):w[f]=l.getValue(A,p)}});w[n]=m;m++;B=w[t];var D=w[u];null==D||null==B||isNaN(B)||isNaN(D)||(z&&-1===g.indexOf(z,t)&&delete w[t],z&&-1===g.indexOf(z,u)&&delete w[u],b.featureSet.features.push({geometry:{x:D,y:B,spatialReference:{wkid:4326}},attributes:w}))}b.layerDefinition.name="csv";e&&e(b)}else setTimeout(function(){},1),e&&e(null,Error("File does not seem to contain fields with point coordinates."))},
onError:function(r){e&&e(null,r)}});return!0}function E(a,c,e,h,k,l){0===a.length&&k(null);var r=H.getGeometryType(c),m=[];g.forEach(a,function(b){b=new r(b);b.spatialReference=e;m.push(b)},this);c=[102113,102100,3857];e.wkid&&4326===e.wkid&&h.wkid&&-1<g.indexOf(c,h.wkid)?(g.forEach(m,function(b){b.xmin?(b.xmin=Math.max(b.xmin,-180),b.xmax=Math.min(b.xmax,180),b.ymin=Math.max(b.ymin,-89.99),b.ymax=Math.min(b.ymax,89.99)):b.rings?g.forEach(b.rings,function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],
-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.paths?g.forEach(b.paths,function(n){g.forEach(n,function(d){d[0]=Math.min(Math.max(d[0],-180),180);d[1]=Math.min(Math.max(d[1],-89.99),89.99)},this)},this):b.x&&(b.x=Math.min(Math.max(b.x,-180),180),b.y=Math.min(Math.max(b.y,-89.99),89.99))},this),a=[],g.forEach(m,function(b){b=I.geographicToWebMercator(b);102100!==h.wkid&&(b.spatialReference=h);a.push(b.toJson())},this),k(a)):null!==e.wkid&&-1<g.indexOf(c,e.wkid)&&null!==h.wkid&&
4326===h.wkid?(a=[],g.forEach(m,function(b){a.push(I.webMercatorToGeographic(b).toJson())},this),k(a)):(c=function(b,n){b&&b.length===a.length?(a=[],g.forEach(b,function(d){d&&(d.rings&&0<d.rings.length&&0<d.rings[0].length&&0<d.rings[0][0].length&&!isNaN(d.rings[0][0][0])&&!isNaN(d.rings[0][0][1])||d.paths&&0<d.paths.length&&0<d.paths[0].length&&0<d.paths[0][0].length&&!isNaN(d.paths[0][0][0])&&!isNaN(d.paths[0][0][1])||d.xmin&&!isNaN(d.xmin)&&d.ymin&&!isNaN(d.ymin)||d.x&&!isNaN(d.x)&&d.y&&!isNaN(d.y))?
a.push(d.toJson()):a.push(null)},this),k(a)):l(b,n)},G.defaults.geometryService?G.defaults.geometryService.project(m,h,q.hitch(this,c),l):k(null))}function Q(a,c){var e=[102113,102100,3857];return a&&c&&a.wkid===c.wkid&&a.wkt===c.wkt||a&&c&&a.wkid&&c.wkid&&-1<g.indexOf(e,a.wkid)&&-1<g.indexOf(e,c.wkid)?!0:!1}function R(a,c,e,h){if(a.featureSet&&0!==a.featureSet.features.length)if(Q(e,c))h(a);else{var k=function(b){var n=[];g.forEach(a.featureSet.features,function(d,v){b[v]&&(d.geometry=b[v],n.push(d))},
this);h(a)},l=function(b,n){h(a)},r=function(b,n){E(m,a.featureSet.geometryType,c,e,q.hitch(this,k),q.hitch(this,l))};if(a.featureSet.features&&0<a.featureSet.features.length){var m=[];g.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)m.push(b.geometry);else{var n=H.getGeometryType(a.featureSet.geometryType);m.push(new n(b.geometry))}});c.toJson||(c=new C(c));e.toJson||(e=new C(e));E(m,a.featureSet.geometryType,c,e,q.hitch(this,k),q.hitch(this,r))}else h(a)}}var N="lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),
O="lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" "),S={latFieldStrings:N,longFieldStrings:O,buildCSVFeatureCollection:function(a){var c=new F,e=function(k,l){l?c.errback(l):c.callback(k)},h={url:a.url,handleAs:"text",load:function(k){L(k,a,q.hitch(this,e))},error:function(k){c.errback(k)}};-1<a.url.indexOf("arcgis.com")&&-1<a.url.indexOf("/content/items")&&-1<a.url.indexOf("/data")&&(h.headers={"Content-Type":""});X(h,{usePost:!1});return c},projectFeatureCollection:function(a,
c,e){var h=new F;e||(e=new C({wkid:4326}));R(a,e,c,q.hitch(this,function(k){h.callback(k)}));return h},generateDefaultPopupInfo:function(a){var c={esriFieldTypeDouble:1,esriFieldTypeSingle:1},e={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},h={esriFieldTypeDate:1},k=null;a=g.map(a.layerDefinition.fields,q.hitch(this,function(l){"NAME"===l.name.toUpperCase()&&(k=l.name);var r="esriFieldTypeOID"!==l.type&&"esriFieldTypeGlobalID"!==l.type&&"esriFieldTypeGeometry"!==l.type,m=null;if(r){var b=l.name.toLowerCase();
if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+b+",")||-1<b.indexOf("area")||-1<b.indexOf("length")||-1<b.indexOf("shape")||-1<b.indexOf("perimeter")||-1<b.indexOf("objectid")||b.indexOf("_")===b.length-1||b.indexOf("_i")===b.length-2&&1<b.length)r=!1;l.type in e?m={places:0,digitSeparator:!0}:l.type in c?m={places:2,digitSeparator:!0}:l.type in h&&(m={dateFormat:"shortDateShortTime"})}return q.mixin({},{fieldName:l.name,label:l.alias,
isEditable:!0,tooltip:"",visible:r,format:m,stringFieldOption:"textbox"})}));return{title:k?"{"+k+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:J,_isValidDate:K,_processCsvData:L,_projectGeometries:E,_sameSpatialReference:Q,_projectFeatureSet:R};q.setObject("arcgis.csv",S,W);return S});