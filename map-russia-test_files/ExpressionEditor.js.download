//>>built
require({cache:{"url:esri/dijit/templates/ExpressionEditor.html":'\x3cdiv class\x3d"modal"\x3e\r\n  \x3cdiv class\x3d"modal-content"\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"_expressionEditorLoading" class\x3d"throb-loading" style\x3d"border:none;height:100%;"\x3e\x3c/div\x3e\r\n    \x3ciframe data-dojo-attach-point\x3d"_expressionEditor" scrolling\x3d"auto" style\x3d"border:none;width:100%;height:100%;visibility:hidden;"\x3e\x3c/iframe\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n'}});
define("esri/dijit/ExpressionEditor","dojo/_base/declare dojo/_base/kernel dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/html dojo/Evented dojo/string dojo/dom dojo/has dojo/topic dojo/query dojo/aspect dojo/_base/json dojo/Deferred dojo/dom-class dojo/dom-style dijit/registry dijit/TooltipDialog dijit/Tooltip dojo/store/Memory ../layers/ArcGISImageServiceLayer ../layers/ArcGISImageServiceVectorLayer ../layers/ArcGISDynamicMapServiceLayer ../layers/ArcGISTiledMapServiceLayer ../support/expressionUtils ../lang ../symbols/jsonUtils ../geometry/Point ../geometry/Polyline ../geometry/Polygon ../SpatialReference ../tasks/QueryTask ../tasks/query dojo/i18n!../nls/jsapi dijit/_Widget dijit/_Templated dojo/text!./templates/ExpressionEditor.html".split(" "),
function(m,k,e,g,l,I,J,h,K,L,M,N,O,r,P,Q,t,R,S,T,U,z,A,B,V,u,p,W,C,D,E,v,w,x,y,F,G,H){m=m([F,G],{declaredClass:"esri.dijit.ExpressionEditor",basePath:require.toUrl("."),baseClass:"esriAGOExpressionEditor",widgetsInTemplate:!0,templateString:H,i18n:null,constructor:function(a,d){a&&(e.mixin(this,a),this.defaultExpressionScript=this.defaultExpressionScript||"")},destroy:function(){clearInterval(this.editorFrameListener);window.removeEventListener("message",this.receiveMessageHitch);this.inherited(arguments)},
postMixInProperties:function(){this.inherited(arguments);this.i18n=e.clone(y.common);e.mixin(this.i18n,y.rendererCommon)},postCreate:function(){},_onClose:function(a){a.preventDefault();l.publish("expression-cancel")},startup:function(){this.inherited(arguments);this._init()},_init:function(){var a=0;this.editorFrameLoaded=!1;this.editorUrl=this.arcadeEditor+"?locale\x3d"+k.locale;this._expressionEditor.onload=e.hitch(this,function(){t.set(this._expressionEditorLoading,"display","none");t.set(this._expressionEditor,
"visibility","visible")});this._expressionEditor.src=this.editorUrl;this.receiveMessageHitch=e.hitch(this,"receiveMessage");window.addEventListener("message",this.receiveMessageHitch,!1);this.editorFrameListener=setInterval(e.hitch(this,function(){this.editorFrameLoaded?(clearInterval(this.editorFrameListener),this.editorFrameListener=null):this.sendPostMessage({type:"isLoaded"});a++;60<a&&l.publish("expression-cancel")}),500)},sendPostMessage:function(a){this._expressionEditor&&this._expressionEditor.contentWindow&&
this._expressionEditor.contentWindow.postMessage(r.toJson(a),this.editorUrl)},receiveMessage:function(a){if(-1!==this.editorUrl.indexOf(a.origin)){var d="string"===typeof a.data?r.fromJson(a.data):a.data;switch(d.type){case "loaded":if(this.editorFrameLoaded=d.value){var b=this.layer instanceof A,c=this.mapLayer.layer instanceof B,q="esri.layers.ArcGISTiledMapServiceLayer"===this.mapLayer.layer.declaredClass;if(this.layer instanceof z||b){if(!this.mapLayer._queryResponse){b=new w(this.layer.url);
c=new x;c.where="1\x3d1";c.num=1;c.outFields=["*"];c.outSpatialReference=this.map.spatialReference;b.execute(c,k.hitch(this,function(f){this.mapLayer._queryResponse=f;this.receiveMessage(a)}),k.hitch(this,function(){this.mapLayer._queryResponse={};this.receiveMessage(a)}));break}}else if((c||q)&&this.layer.url&&(this.mapLayer._queryResponse=this.mapLayer._queryResponse||[],!this.mapLayer._queryResponse[this.layer.url])){b=new w(this.layer.url);c=new x;c.where="1\x3d1";c.num=1;c.outFields=["*"];c.outSpatialReference=
this.map.spatialReference;b.execute(c,k.hitch(this,function(f){this.mapLayer._queryResponse[this.layer.url]=f;this.receiveMessage(a)}),k.hitch(this,function(){this.mapLayer._queryResponse[this.layer.url]={};this.receiveMessage(a)}));break}b={type:"initializeDialog",title:this.expressionTitle?this.expressionTitle:this.i18n.custom,captureTitle:p.isDefined(this.captureTitle)?this.captureTitle:!0,predictOutputType:!0,script:this.expression?this.expression:this.defaultExpressionScript,profile:this.arcadeProfile?
this.arcadeProfile:this.makeCurrentProfile(),existing:this.makeExistingList(),spatialReference:this.map.spatialReference.toJson(),includeGeometryWarning:!1};this.arcadeProfileType?(b.profileName=this.arcadeProfileType,"geoanalyticstrack"===this.arcadeProfileType&&b.profile[0].value&&(b.trackData={layer:b.profile[0].value.layer,track:[{attributes:b.profile[0].value.attributes&&b.profile[0].value.attributes,geometry:b.profile[0].value.geometry&&b.profile[0].value.geometry}],trackstarttime:(new Date).getTime(),
trackindex:1,trackduration:10,trackcurrenttime:(new Date).getTime()})):this.arcadeProfileType&&"geoanalyticstrack"===this.arcadeProfileType||(b.bannedFunctions="TrackCurrentTime TrackDuration TrackFieldWindow TrackGeometryWindow TrackIndex TrackStartTime TrackWindow".split(" "));this.sendPostMessage(b)}case "initFinished":break;case "scriptSaveAndClose":if(!d.script||d.script===this.defaultExpressionScript){l.publish("expression-cancel");break}var n=function(f){l.publish("expression-commit",[{expression:f.script,
returnType:"Number"===f.predictOutputType?"esriFieldTypeDouble":"String"===f.predictOutputType?"esriFieldTypeString":"esriFieldTypeUnknown",title:f.title}])};u.hasGeometryOperations(d.script)?u.enableGeometryOperations().then(function(){n(d)}):n(d);break;case "scriptClose":l.publish("expression-cancel")}}},makeCurrentProfile:function(){var a=this.layer.fields,d=[{type:"Feature",value:{attributes:null,geometry:null,layer:{fields:g.map(a,function(c){return c}),objectIdField:this.layer.objectIdField,
typeIdField:this.layer.typeIdField,types:this.layer.types?g.map(this.layer.types,function(c){return c.toJson?c.toJson():c}):null,templates:this.layer.templates}},id:p.isDefined(this.fieldId)?this.fieldId:"$feature"}];this.showViewScale&&d.push({type:"Dictionary",value:{attributes:{scale:this.map.getScale()},layer:{fields:[{name:"scale",alias:this.i18n.currentMapScale,type:"Number"}]}},id:"$view"});if(this.mapLayer._queryResponse&&this.mapLayer._queryResponse.features&&this.mapLayer._queryResponse.features.length)d[0].value.attributes=
e.clone(this.mapLayer._queryResponse.features[0].attributes),d[0].value.geometry=this.mapLayer._queryResponse.features[0].geometry;else if(this.mapLayer._queryResponse&&this.mapLayer._queryResponse[this.layer.url]&&this.mapLayer._queryResponse[this.layer.url].features&&this.mapLayer._queryResponse[this.layer.url].features.length)d[0].value.attributes=e.clone(this.mapLayer._queryResponse[this.layer.url].features[0].attributes),d[0].value.geometry=this.mapLayer._queryResponse[this.layer.url].features[0].geometry;
else if(this.layer.graphics&&this.layer.graphics.length)d[0].value.attributes=e.clone(this.layer.graphics[0].attributes),d[0].value.geometry=this.layer.graphics[0].geometry.toJson();else{var b={};g.forEach(a,function(c){-1<g.indexOf("esriFieldTypeSmallInteger esriFieldTypeInteger esriFieldTypeSingle esriFieldTypeDouble esriFieldTypeString esriFieldTypeDate esriFieldTypeOID esriFieldTypeGlobalID".split(" "),c.type)?!1===c.nullable?c.defaultValue?b[c.name]=c.defaultValue:-1<g.indexOf(["esriFieldTypeString"],
c.type)?b[c.name]="":b[c.name]=0:b[c.name]=null:b[c.name]=null});d[0].value.attributes=b;a=this.map.extent;"esriGeometryPolygon"==this.layer.geometryType||this.layer.getCustomRasterFields?(d[0].value.geometry=new E(new v(this.map.spatialReference.toJson())),d[0].value.geometry.addRing([[a.xmin,a.ymin],[a.xmax,a.ymin],[a.xmax,a.ymax],[a.xmin,a.ymax],[a.xmin,a.ymin]])):"esriGeometryPoint"==this.layer.geometryType||"esriGeometryMultipoint"==this.layer.geometryType?d[0].value.geometry=new C(a.getCenter().toJson()):
"esriGeometryPolyline"==this.layer.geometryType&&(d[0].value.geometry=new D(new v(this.map.spatialReference.toJson())),d[0].value.geometry.addPath([[a.xmin,a.ymin],[a.xmax,a.ymax]]))}return d},makeExistingList:function(){var a=k.hitch(this,function(c,q,n){if(c&&(c.shortTitle!==this.expressionTitle||c.valueExpression!==this.expression)){c={shortTitle:c.shortTitle||this.i18n.untitled,script:c.valueExpression,returnType:c.returnType};switch(n){case "color":c.title=h.substitute(this.i18n.expressionOriginColor,
{title:c.shortTitle});break;case "size":c.title=h.substitute(this.i18n.expressionOriginSize,{title:c.shortTitle});break;case "type":c.title=h.substitute(this.i18n.expressionOriginColor,{title:c.shortTitle});break;case "transparency":c.title=h.substitute(this.i18n.expressionOriginTransparency,{title:c.shortTitle});break;case "rotation":c.title=h.substitute(this.i18n.expressionOriginRotation,{title:c.shortTitle});break;default:c.title=c.shortTitle}q.push(c)}}),d=[],b=this.getRendererCustomExpression(this.layer.renderer,
"color");a(b,d,"color");b=this.getRendererCustomExpression(this.layer.renderer,"size");a(b,d,"size");b=this.getRendererCustomExpression(this.layer.renderer,"type");a(b,d,"type");b=this.getRendererCustomExpression(this.layer.renderer,"transparency");a(b,d,"transparency");b=this.getRendererCustomExpression(this.layer.renderer,"rotation");a(b,d,"rotation");if(this.layer.labelingInfo||this.layer.drawingInfo&&this.layer.drawingInfo.labelingInfo)a=this.layer.drawingInfo?this.layer.drawingInfo.labelingInfo[0]:
this.layer.labelingInfo[0],a.labelExpressionInfo&&a.labelExpressionInfo.expression&&a.name&&(a.name!==this.expressionTitle||a.labelExpressionInfo.expression!==this.expression)&&d.push({shortTitle:a.name||this.i18n.untitled,title:h.substitute(this.i18n.expressionOriginLabels,{title:a.name||this.i18n.untitled}),script:a.labelExpressionInfo.expression});a=this.latestPopupInfo||this.mapLayer.popupInfo;if(!a&&this.mapLayer.itemLayers)for(b=0;b<this.mapLayer.itemLayers.length;b++)if(this.mapLayer.itemLayers[b].id===
this.layer.id){a=this.mapLayer.itemLayers[b].popupInfo;break}a&&a.expressionInfos&&g.forEach(a.expressionInfos,function(c){!c||c.title===this.expressionTitle&&c.expression===this.expression||d.push({shortTitle:c.title||this.i18n.untitled,title:h.substitute(this.i18n.expressionOriginPopup,{title:c.title||this.i18n.untitled}),script:c.expression})},this);return d},getRendererCustomExpression:function(a,d){if(!a)return null;if(a.valueExpression&&("esri.renderer.UniqueValueRenderer"==a.declaredClass||
"esri.renderer.ClassBreaksRenderer"==a.declaredClass&&!this.getVisualVariableByType("colorInfo",null,a.visualVariables)&&!this.getVisualVariableByType("sizeInfo",null,a.visualVariables))&&"type"===d)return d="esriFieldTypeDouble","esri.renderer.UniqueValueRenderer"==a.declaredClass&&a.infos&&a.infos[0]&&"string"===typeof a.infos[0].value&&(d="esriFieldTypeString"),{valueExpression:a.valueExpression,returnType:d,shortTitle:a.valueExpressionTitle||a.legendOptions&&a.legendOptions.title};if(a.visualVariables){var b=
this.getVisualVariableByType("colorInfo",null,a.visualVariables);if(b&&b.valueExpression&&"color"===d||(b=this.getVisualVariableByType("sizeInfo",null,a.visualVariables))&&b.valueExpression&&"size"===d||(b=this.getVisualVariableByType("opacityInfo",null,a.visualVariables))&&b.valueExpression&&"transparency"===d||(b=this.getVisualVariableByType("rotationInfo",null,a.visualVariables))&&b.valueExpression&&"rotation"===d)return{valueExpression:b.valueExpression,returnType:"esriFieldTypeDouble",shortTitle:b.valueExpressionTitle||
b.legendOptions&&b.legendOptions.title}}return a.observationRenderer?this.getRendererCustomExpression(a.observationRenderer):a.latestObservationRenderer?this.getRendererCustomExpression(a.latestObservationRenderer):null},getVisualVariableByType:function(a,d,b){return b&&(b=g.filter(b,function(c){return p.isDefined(d)?c.type===a&&c.target===d:c.type===a&&!c.target}),b.length)?e.clone(b[0]):null}});e.setObject("esri.dijit.ExpressionEditor",m);return m});