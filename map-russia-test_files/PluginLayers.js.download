//>>built
define("esri/dijit/analysis/PluginLayers","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/Deferred dojo/promise/all dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-style dojo/query dojo/store/Memory dojo/store/Observable dojo/Evented dojo/has ./ItemTypes ../../request ../../kernel ../../lang dgrid/OnDemandGrid dgrid/Selection ./AnalysisRegistry dojo/i18n!../../nls/jsapi".split(" "),function(u,h,l,r,x,I,y,z,A,J,v,B,C,D,K,e,w,E,m,F,G,k,t){var q=u([D],{infoPanelTemplate:'\x3cdiv\x3e\x3cdiv class\x3d"template-info-showing"\x3e\x3cdiv\x3e\x3cimg width\x3d\'16px\' height\x3d\'16px\' alt\x3d\'\' src\x3d\'${item.iconUrl}\'\x3e\x3c/div\x3e\x3ch4\x3e${item.title}\x3c/h4\x3e\x3cdiv class\x3d"template-info"\x3e\x3cp class\x3d""\x3e${item.snippet}\x3c/p\x3e${item:plugIn._showLayers}\x3cdiv id\x3d"${item.id}_details" class\x3d"quiet-scroll layer-container"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"panel-actions"\x3e${item:plugIn._addLayerToMap}\x3cbutton class\x3d"btn blue btn-main disabled" id\x3d"add-layer"\x3e${i18n.common.addLayerBtnLabel}\x3c/button\x3e\x3cbutton class\x3d"btn btn-cancel" id\x3d"close-panel"\x3e${i18n.common.close}\x3c/button\x3e\x3c/div\x3e\x3cdiv\x3e',
geometryTypes:[k.GeometryTypes.Point,k.GeometryTypes.Point.MultiPoint,k.GeometryTypes.Line,k.GeometryTypes.Polygon],layerTypes:[e.FLAYER,e.BDATAFEATURE,e.BTABLE,e.TABLE],timeTypes:[k.TimeTypes.Instant,k.TimeTypes.Interval],checkGeometryType:!0,checkLayerType:!1,checkTimeFilter:!1,fetchType:['type:"'+e.MS+'"','type:"'+e.FS+'"'],constructor:function(a){h.mixin(this,a);this.filters={all:{},mycontent:{owners:this.self?[this.self.user.username]:[]},esriBoundaryLayers:{owners:["esri_boundaries"]}};this.i18n=
h.mixin({},t.browseLayersDlg);h.mixin(this.i18n,t.browseItems);h.mixin(this.i18n,t.common);this.filterStrings={all:{title:this.self&&this.self.isPortal?this.i18n.items.portalOrg:this.i18n.items.organizationLabel},mycontent:{title:this.i18n.items.contentLabel},esriBoundaryLayers:{title:this.i18n.esriBoundaryLayers}}},fetchData:function(){this._portal=this.parent._portal;this._user=this._portal.getPortalUser();this.filters.mycontent.owner=this._user;this.parent.fetchType&&(this.fetchType=this.parent.fetchType);
return this._fetchItems()},_fetchItems:function(){return this.parent._fetchItems({types:this.fetchType})},_fetchServiceInfo:function(a){var b=new x,f,c={f:"json"};a.url?(-1!==window.location.protocol.indexOf("https:")&&(a.url=a.url.replace("http:","https:")),w({url:a.url,content:c}).then(function(d){b.resolve(d)},h.hitch(this,function(d){f=d.details&&d.details.length?d.details.shift():"";d&&403===d.httpCode&&-1<f.indexOf("SSL Required")?(a.set("url",a.url.replace("http:","https:")),this._fetchServiceInfo(a).then(function(g){b.resolve(g)})):
(a.isLoaded=!0,b.resolve({error:d}))}))):b.resolve(null);return b},_addLayerToMap:function(a){return a.type===e.BIGDATA||a.type===e.CSV||a.type===e.XLS?"":'\x3cdiv class\x3d"esriFloatLeading esriLeadingPadding1 padding-trailer-half js-add-layer-node"\x3e\x3clabel\x3e\x3cinput name\x3d"addlayertomap" class\x3d"js-add-layer-checkbox" type\x3d"checkbox"\x3e\x3cspan class\x3d"esriLeadingPadding1"\x3e'+this.i18n.common.addLayer+"\x3c/span\x3e\x3c/label\x3e\x3c/div\x3e"},_showLayers:function(a){if(a&&-1!==
l.indexOf([e.FS,e.MS,e.IS,e.BIGDATA,e.CSV,e.XLS],a.type)){if(a.type===e.CSV||a.type===e.XLS)a.url=a.itemUrl;this.plugIn._fetchServiceInfo(a).then(h.hitch(this,function(b){var f=[],c={f:"json"};b.layers&&(f=[].concat(f).concat(b.layers));b.tables&&0<b.tables.length&&(f=[].concat(f).concat(b.tables));b.children&&(f=b.children);!a||a.type!==e.CSV&&a.type!==e.XLS&&a.type!==e.IS||(f=[a]);if(!f.length)var d=this.plugIn.i18n.noDataMessages.noItemInfo;this.plugIn._createLayerGrid(r.create("div",null,y.byId(a.id+
"_details")),d);l.forEach(f,function(g,n){a.type===e.BIGDATA?(g.url=a.url+"/"+g.name,g.url=encodeURI(g.url)):g.url=a.type===e.CSV?a.itemUrl:a.type===e.IS?a.url:a.url+"/"+n;-1!==window.location.protocol.indexOf("https:")&&(g.url=g.url.replace("http:","https:"));w({url:g.url,content:c}).then(h.hitch(this,function(p){g=h.mixin(g,p);this.plugIn._store.put(g);this.plugIn._grid.refresh()}),h.hitch(this,function(p){this.plugIn._grid.noDataMessage=this.plugIn.i18n.noDataMessages.noLayerInfo;this.plugIn._grid.refresh()}))},
this)}))}return""},_getLayerHead:function(){return"\x3ctr\x3e\x3cth\x3e\x3c/th\x3e\x3cth\x3eLayer Name\x3c/th\x3e\x3cth\x3e Geometry Type\x3c/th\x3e\x3c/tr\x3e"},_getLayerNode:function(a,b,f){b=a.name;var c='\x3ctr\x3e\x3ctd\x3e\x3cinput type\x3d"checkbox" class\x3d"js-layer-check" name\x3d"layers" value\x3d"'+b+' checked"\x3e\x3c/td\x3e\x3ctd\x3e',d="\x3c/td\x3e\x3ctd\x3e"+a.geometryType+"\x3c/td\x3e\x3c/tr\x3e";return a.itemUrl||a.url?c+'\x3ca class\x3d"'+(f||"")+'"\x3e'+b+"\x3c/a\x3e"+d:c+b+d},
_createLayerGrid:function(a,b){var f=u([F,G]);this._store=C(new B({idProperty:"name"}));this._atleastALayerAvailable=!1;this._grid=new f({store:this._store,query:h.hitch(this,function(c){var d=!0,g=!0,n=!0,p=!0;this.checkGeometryType&&c.type!==e.IS&&(n=-1!==l.indexOf(this.geometryTypes,c.geometryType));this.checkTimeFilter&&(d=-1!==l.indexOf(this.timeTypes,this.getTimeType(c)));this.checkLayerType&&(g=-1!==l.indexOf(this.layerTypes,c.type));"function"===typeof this.customCheckHandler&&(p=this.customCheckHandler(c));
c=c&&n&&d&&g&&p;c||(this._grid.noDataMessage=this.getNoDataMessage({geomCheck:n,timeCheck:d,typeCheck:g,customCheck:p}));!this._atleastALayerAvailable&&c&&(this._atleastALayerAvailable=c);v(".js-add-layer-checkbox",this.parent.infoPanel).forEach(function(H){z.set(H,"disabled",!this._atleastALayerAvailable)},this);return c}),selectionMode:"single","class":"esriAnalysisLayersGrid quiet-scroll",noDataMessage:b||this.i18n.noValidLayerMsg,allowSelect:h.hitch(this,function(c){var d;this.checkLayerType&&
c.data&&(d=-1!==l.indexOf(this.layerTypes,c.data.type));d=c.data.geometryType?-1!==l.indexOf(this.geometryTypes,c.data.geometryType)||this.checkLayerType&&d:!0;return c&&c.data&&d}),renderRow:h.hitch(this,this._renderer)},a);this._grid.startup();this._grid.on("dgrid-select,dgrid-deselect",h.hitch(this,function(c){c=c.grid.selection;var d=[];for(g in c)c[g]&&d.push(this._grid.row(g).data);var g={selection:d};v(".panel-actions .btn-main",this.parent.infoPanel).forEach(function(n){A.toggle(n,"disabled",
0===d.length)},this);d[0]&&(this._selectedLayer=d[0]);this.emit("layer-change",g)}))},hasTimeInfo:function(a){return a&&a.timeInfo},getTimeType:function(a){return a?m.isDefined(a.timeInfo)&&m.isDefined(a.timeInfo.startTimeField)&&!m.isDefined(a.timeInfo.endTimeField)?k.TimeTypes.Instant:m.isDefined(a.timeInfo)&&m.isDefined(a.timeInfo.startTimeField)&&m.isDefined(a.timeInfo.endTimeField)?k.TimeTypes.Interval:m.isDefined(a.time)&&m.isDefined(a.time.timeType)?a.time.timeType:!1:!1},getNoDataMessage:function(a){if(a.geomCheck)if(a.timeCheck){if(!a.typeCheck)return this.i18n.noDataMessages.typeCheckFailure;
if(!a.customCheck)return this.customCheckFailureMessage}else return this.i18n.noDataMessages.timeCheckFailure;else return this.i18n.noDataMessages.geomCheckFailure},getDateFields:function(a){return l.filter(a&&a.fields||[],function(b){return b&&"esriFieldTypeDate"===b.type})},_renderer:function(a){a.snippet=a.snippet||"";var b=r.create("div"),f=this._getLabel(a);r.place('\x3cdiv class\x3d"panel panel-white panel-bordered panel-compact border-bottom-clear"\x3e\x3ch5 class\x3d"trailer-0 font-size-0 word-break"\x3e\x3ca\x3e'+
a.name+'\x3c/a\x3e\x3c/h5\x3e\x3cnav class\x3d"inline-block"\x3e\x3ca class\x3d"link-gray font-size--2 esriTrailingPadding1 esriTrailingMargin05"\x3e\x3cspan class\x3d"'+f.icon+'"\x3e\x3c/span\x3e'+f.name+"\x3c/a\x3e"+(a.timeInfo||a.time&&"instant"===a.time.timeType?'\x3ca class\x3d"link-gray font-size--2 esriTrailingPadding1" data-action\x3d"timeSettings" data-layerid\x3d"0"\x3e\x3cspan class\x3d"esri-icon-time-clock"\x3e\x3c/span\x3e'+this.i18n.timeEnabled+"\x3c/a\x3e":'\x3ca class\x3d"esriTrailingPadding1"\x3e\x3c/a\x3e')+
"\x3c/nav\x3e\x3c/div\x3e",b);return b},_getLabel:function(a){var b={icon:"",name:""},f=a.geometryType;f===k.GeometryTypes.Point||f===k.GeometryTypes.MultiPoint?(b.name=this.i18n.points,b.icon="esri-icon-map-pin"):f===k.GeometryTypes.Polygon?(b.name=this.i18n.areas,b.icon="esri-icon-polygon"):f===k.GeometryTypes.Line?(b.name=this.i18n.lines,b.icon="esri-icon-polyline"):a.type===e.IS?(b.name=this.i18n.imageService,b.icon="esri-icon-layers"):(b.name=this.i18n.table,b.icon="esri-icon-table");return b}});
h.mixin(q,{add:function(a,b){a.plugIn||(b=b||{},b.parent=a,b.self=a.self,a.plugIn=new q(b))},remove:function(a){a.plugIn&&(a.plugIn.destroy(),delete a.plugIn)}});h.setObject("dijit.analysis.PluginLayers",q,E);return q});