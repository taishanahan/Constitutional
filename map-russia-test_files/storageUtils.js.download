//>>built
define("esri/dijit/analysis/storageUtils","dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/promise/all dojo/has dojo/json ../../request ../../kernel".split(" "),function(n,p,f,l,q,u,k,m,t){p={MAX_RESOURCES:10,checkResourceLimit:!0,_getItemUrl:function(b){var a=b.folderId||b.ownerFolder;return this._portalUrl+"/sharing/rest/content/users/"+b.owner+"/"+(a?a+"/":"")+"/items/"+b.id},addToItemResource:function(b,a){this._portalUrl=a.portalUrl;delete a.portalUrl;b=this._getItemUrl(b);
b+="/addResources";a={filename:a.jobInfo.jobId+".json",text:k.stringify(a),resourcesPrefix:"jobs",f:"json"};return m({url:b,content:a},{usePost:!0})},getItemResource:function(b,a){a&&a.portalUrl&&(this._portalUrl=a.portalUrl);b=this._getItemUrl(b);b+="/resources/"+a.resource;return m({url:b,content:{f:"json"}})},removeItemResource:function(b,a){a&&a.portalUrl&&(this._portalUrl=a.portalUrl);b=this._getItemUrl(b);return m({url:b+"/removeResources",content:{resource:a.resource,deleteAll:a.deleteAll,
f:"json"}},{usePost:!0})},addToStorage:function(b){if(window.sessionStorage){var a=window.sessionStorage.getItem("esri_analysis_jobhistory");a=a?k.parse(a):[];a.push(b);window.sessionStorage.setItem("esri_analysis_jobhistory",k.stringify(a))}},addAllToStorage:function(b){window.sessionStorage&&window.sessionStorage.setItem("esri_analysis_jobhistory",k.stringify(b))},removeFromStorage:function(b){if(window.sessionStorage){var a=window.sessionStorage.getItem("esri_analysis_jobhistory");a&&(a=k.parse(a));
a=n.filter(a,function(c){return c.jobInfo&&c.jobInfo.jobId!==b.jobInfo.jobId});window.sessionStorage.setItem("esri_analysis_jobhistory",k.stringify(a))}},removeAllFromStorage:function(){window.sessionStorage&&window.sessionStorage.removeItem("esri_analysis_jobhistory")},getJobsInfoList:function(){var b;window.sessionStorage&&(b=window.sessionStorage.getItem("esri_analysis_jobhistory"))&&(b=k.parse(b));return b},addItemResources:function(b,a){var c=this.getJobsInfoList(),d=[];n.forEach(c,function(e){e.portalUrl=
a.portalUrl;var g=new l;d.push(g);this.addToItemResource(b,e).then(f.hitch(this,function(h){h&&!0===h.success&&(this.removeFromStorage(e),g.resolve(h))}))},this);return q(d)},saveJobsQueue:function(b,a){var c=this.getJobsInfoList(),d=new l;c&&0<c.length&&this.removeResourceQueue(b,a).then(f.hitch(this,function(){if(c.length>this.MAX_RESOURCES){for(this.sortJobsInfoList(c,{asc:!1});c.length>this.MAX_RESOURCES;)c.pop();this.addAllToStorage(c)}this.addItemResources(b,a).then(f.hitch(this,function(e){d.resolve(e)}),
f.hitch(this,function(e){d.reject(e)}))}),f.hitch(this,function(e){d.reject(e)}));return d.promise},saveJobsInfoList:function(b,a){return this.checkResourceLimit?this.saveJobsQueue(b,a):this.addItemResources(b,a)},getResources:function(b,a){a&&a.portalUrl&&(this._portalUrl=a.portalUrl);b=this._getItemUrl(b);return m({url:b+"/resources",content:{f:"json"}})},getResourcesInfo:function(b,a){var c=[],d=new l;this.sortResources(b,a).then(f.hitch(this,function(e){n.forEach(e.resources,function(g){a.resource=
g.resource;c.push(this.getItemResource(b,a))},this);q(c).then(f.hitch(this,function(g){d.resolve(g)}),f.hitch(this,function(g){d.reject(g)}))}),f.hitch(this,function(e){d.reject(e)}));return d.promise},sortJobsInfoList:function(b,a){b.sort(f.hitch(this,function(c,d){return a.asc?c.timestamp-d.timestamp:d.timestamp-c.timestamp}))},sortResources:function(b,a){var c=new l;this.getResources(b,a).then(f.hitch(this,function(d){d.resources&&0<d.resources.length&&d.resources.sort(f.hitch(this,function(e,
g){return a.asc?e.created-g.created:g.created-e.created}));c.resolve(d)}),f.hitch(this,function(d){c.reject(d)}));return c.promise},removeResourceQueue:function(b,a){var c=new l,d=[];var e=this.getJobsInfoList().length;var g=this.MAX_RESOURCES-e;g=0<g?g:0;a.asc=!0;this.sortResources(b,a).then(f.hitch(this,function(h){if(h&&h.resources&&0<h.resources.length)if(0===g){var r=h.resources.shift();a.resource=r.resource;a.deleteAll=!0;d.push(this.removeItemResource(b,a));h.resources=[]}else for(;h.resources.length>
g;)r=h.resources.shift(),a.resource=r.resource,d.push(this.removeItemResource(b,a));q(d).always(f.hitch(this,function(){c.resolve(h)}))}),f.hitch(this,function(h){c.reject(h)}));return c.promise}};f.setObject("dijit.analysis.storageUtils",p,t);return p});